System.register(["jimu-core"],(function(e){var t;return{setters:[function(e){t=e}],execute:function(){e(function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=175)}({1:function(e,r){e.exports=t},175:function(e,t,r){"use strict";r.r(t),r.d(t,"JimuCoreDataSourceFactory",(function(){return ge})),r.d(t,"AbstractDataSource",(function(){return s})),r.d(t,"AbstractLayerFolderDataSource",(function(){return v})),r.d(t,"AbstractLoadableDataSource",(function(){return D})),r.d(t,"AbstractQueriableDataSource",(function(){return V})),r.d(t,"AbstractSetDataSource",(function(){return h})),r.d(t,"AbstractDataRecord",(function(){return _})),r.d(t,"SimpleDataRecordImpl",(function(){return j})),r.d(t,"SimpleDataRecordSetImpl",(function(){return T})),r.d(t,"DataSourceStatus",(function(){return i.b})),r.d(t,"DataSourceTypes",(function(){return i.c})),r.d(t,"SupportedLayerServiceTypes",(function(){return i.f})),r.d(t,"SupportedServiceTypes",(function(){return i.h})),r.d(t,"SupportedItemTypes",(function(){return i.e})),r.d(t,"SupportedLayerTypes",(function(){return i.g})),r.d(t,"QueryScope",(function(){return i.d})),r.d(t,"DataSourceError",(function(){return i.a})),r.d(t,"FeatureDataRecordImpl",(function(){return x})),r.d(t,"CsvDataSourceImpl",(function(){return N})),r.d(t,"FeatureLayerDataSourceImpl",(function(){return z})),r.d(t,"FeatureServiceDataSourceImpl",(function(){return K})),r.d(t,"GroupLayerDataSourceImpl",(function(){return te})),r.d(t,"MapServiceDataSourceImpl",(function(){return ie})),r.d(t,"SimpleLocalDataSourceImpl",(function(){return ce})),r.d(t,"SceneServiceDataSourceImpl",(function(){return fe})),r.d(t,"SceneLayerDataSourceImpl",(function(){return Se}));var n,o=r(1),i=r(2),a=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},u=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},s=function(){function e(e){if(this.isDataSourceSet=!1,this.records=[],Object.assign(this,e),this.originDataSourceJson=e.dataSourceJson,e.dataSourceJson)this.isDataView=!1,this.isLocal=!1,e.dataSourceJson.url&&(this.url=e.dataSourceJson.url);else{if(!e.belongToDataSource)return void console.error("bad DataSourceConstructorOptions.");e.localId?(this.isLocal=!0,this.isDataView=!1):(this.isLocal=!1,this.isDataView=!0)}this.getDataSourceJson().isDataInDataSourceInstance&&(this.sourceRecords=e.sourceRecords,this.url=null),this.isLocal?this.listenSelection=!1:this.listenSelection=!0}return Object.defineProperty(e.prototype,"url",{get:function(){return o.dataSourceUtils.getWhetherUseProxy()&&o.dataSourceUtils.getDataSourceProxyUrl(this._url)||this._url},set:function(e){this._url=e},enumerable:!1,configurable:!0}),e.prototype.getLabel=function(){var e=this.getDataSourceJson().label||this.getSchema().label;if(this.isLocal)return this.belongToDataSource.getLabel();if(this.isDataView){var t=this.getMainDataSource().getDataSourceJson(),r=(null==t?void 0:t.dataViews)&&t.dataViews[this.dataViewId];return(null==r?void 0:r.label)||e}return e},e.prototype.getDataSourceJson=function(){if(this.isDataView||this.isLocal){var e=this.getMainDataSource().getDataSourceJson();return this.dataViewId===o.CONSTANTS.SELECTION_DATA_VIEW_ID&&(e=e.set("isDataInDataSourceInstance",!0)),e}return this.dataSourceJson},e.prototype.setDataSourceJson=function(e){e?this.dataSourceJson?this.dataSourceJson=this.traverseToMergeDataSourceJson(this.dataSourceJson,e):this.dataSourceJson=e:this.dataSourceJson=this.originDataSourceJson},e.prototype.traverseToMergeDataSourceJson=function(e,t){var r=this;if(!e&&!t)return console.error("Can not merge data source json since do not have base data source json or new data source json."),Object(o.Immutable)({});if(!e)return t;if(!t)return e;var n=e.merge(t.asMutable({deep:!0}));return["label","isHidden","useFields","query","dataViews","childDataSourceJsons","schema","url","itemId","portalUrl"].forEach((function(o){t[o]||(n=n.without(o)),t[o]&&"schema"===o&&(n=n.set("schema",t.schema)),!t[o]||"url"!==o&&"portalUrl"!==o&&"itemId"!==o||(n=n.set(o,t[o]),r[o]=t[o],r.canSaveSource()&&r.getAllDerivedDataSources().forEach((function(e){e[o]=t[o]}))),e[o]&&"useFields"===o&&(n=t.schema?n.set("useFields",e.useFields.filter((function(e){var r;return!!(null===(r=t.schema.fields)||void 0===r?void 0:r[e])}))):n.set("useFields",e.useFields))})),n.childDataSourceJsons&&Object.keys(n.childDataSourceJsons).forEach((function(o){var i,a=r.traverseToMergeDataSourceJson(null===(i=null==e?void 0:e.childDataSourceJsons)||void 0===i?void 0:i[o],t.childDataSourceJsons[o]);n=n.setIn(["childDataSourceJsons",o],a)})),n},e.prototype.getSchema=function(){return this.isDataView||this.isLocal?this.getMainDataSource().getSchema():this.schema||{}},e.prototype.getSelectedFields=function(){var e,t,r,n,o,i=this;if(this.isLocal)return this.belongToDataSource.getSelectedFields();var a=(null===(e=this.getSchema())||void 0===e?void 0:e.fields)?Object.keys(this.getSchema().fields):[];if(!(o=this.isDataView?null===(r=null===(t=this.getDataSourceJson().dataViews)||void 0===t?void 0:t[this.dataViewId])||void 0===r?void 0:r.outFields:null===(n=this.getDataSourceJson().query)||void 0===n?void 0:n.outFields)&&!this.selectedFields)return a;var u=a;return o&&(u=u.filter((function(e){return o.includes(e)}))),this.selectedFields&&(u=u.filter((function(e){return i.selectedFields.includes(e)}))),u},e.prototype.setSelectedFields=function(e){this.selectedFields=e},e.prototype.setSchema=function(e){this.schema=e},e.prototype.fetchSchema=function(){return a(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return[4,Promise.resolve(Object(o.Immutable)({}))];case 1:return[2,e.sent()]}}))}))},e.prototype.getFetchedSchema=function(){return this.isDataView||this.isLocal?this.getMainDataSource().getFetchedSchema():this.fetchedSchema},e.prototype.setFetchedSchema=function(e){this.fetchedSchema=e},e.prototype.getGeometryType=function(){return null},e.prototype.getReversedConfigSchema=function(){var e=this;if(this.isDataView||this.isLocal)return this.getMainDataSource().getReversedConfigSchema();if(this.reverseSchema)return this.reverseSchema;if(this.isDataSourceSet){var t=this.getDataSourceJson().schema,r={childSchemas:{}};if(!t)return Object(o.Immutable)({});if(!t.childSchemas)return Object(o.Immutable)({label:t.label,childId:t.childId,jimuChildId:t.jimuChildId});Object.keys(t.childSchemas).forEach((function(n){var o=t.childSchemas[n].childId;r.childSchemas[o]?r.childSchemas[o].push(e.getOneReversedConfigSchema(t.childSchemas[n])):r.childSchemas[o]=[e.getOneReversedConfigSchema(t.childSchemas[n])]})),this.reverseSchema=Object(o.Immutable)(r)}else this.reverseSchema=this.getOneReversedConfigSchema(this.getDataSourceJson().schema);return this.reverseSchema},e.prototype.setRecords=function(e){this.records=e,this.addVersion()},e.prototype.setJsonData=function(e){console.error("please implement this. setJsonData")},e.prototype.getOneReversedConfigSchema=function(e){var t={};return e?(t.fields={},Object.keys(e.fields).forEach((function(r){var n=e.fields[r].asMutable({deep:!0});t.fields[n.name]?t.fields[n.name].push(n):t.fields[n.name]=[n]})),e.childId&&(t.childId=e.childId),e.jimuChildId&&(t.jimuChildId=e.jimuChildId),Object(o.Immutable)(t)):Object(o.Immutable)(t)},e.prototype.getStatus=function(){return Object(o.getAppStore)().getState().dataSourcesInfo[this.id]&&Object(o.getAppStore)().getState().dataSourcesInfo[this.id].status},e.prototype.setStatus=function(e){Object(o.getAppStore)().dispatch(o.appActions.dataSourceStatusChanged(this.id,e))},e.prototype.getCountStatus=function(){return Object(o.getAppStore)().getState().dataSourcesInfo[this.id]&&Object(o.getAppStore)().getState().dataSourcesInfo[this.id].countStatus},e.prototype.setCountStatus=function(e){Object(o.getAppStore)().dispatch(o.appActions.dataSourceCountStatusChanged(this.id,e))},e.prototype.getVersion=function(){var e;return null===(e=Object(o.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.version},e.prototype.addVersion=function(){Object(o.getAppStore)().dispatch(o.appActions.dataSourceVersionAdded(this.id))},e.prototype.getSourceVersion=function(){var e;return this.canSaveSource()?null===(e=Object(o.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.sourceVersion:this.getMainDataSource().getSourceVersion()},e.prototype.addSourceVersion=function(){this.canSaveSource()&&Object(o.getAppStore)().dispatch(o.appActions.dataSourceSourceVersionAdded(this.id))},e.prototype.getSelectedRecordIdsFromInfo=function(){var e,t;return(null===(t=null===(e=Object(o.getAppStore)().getState().dataSourcesInfo)||void 0===e?void 0:e[this.id])||void 0===t?void 0:t.selectedIds)||Object(o.Immutable)([])},e.prototype.setSelectedRecordIdsToInfo=function(e,t){e&&(this.getListenSelection()||this.id===(null==t?void 0:t.id))&&Object(o.getAppStore)().dispatch(o.appActions.dataSourceSelectedIdsChanged(this.id,e))},e.prototype.getRecords=function(e){if(void 0===e&&(e=!0),e&&this.isSelectionView()&&0===this.records.length){var t=this.getMainDataSource().getDataView(o.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION);if(t)return t.getRecords(!1)}return this.records},e.prototype.getRecordsWithSelection=function(){return this.concatRecordsAndSelection(this.getRecords(),this.getSelectedRecords())},e.prototype.concatRecordsAndSelection=function(e,t){var r=e||[];return null==t||t.forEach((function(t){(null==e?void 0:e.some((function(e){return(null==e?void 0:e.getId())===(null==t?void 0:t.getId())})))||(r=r.concat(t))})),r},e.prototype.clearSourceRecordsNotAddVersion=function(){this.clearRecordsNotAddVersion(),this.sourceRecords=[]},e.prototype.clearSourceRecords=function(){this.clearSourceRecordsNotAddVersion(),this.addSourceVersion(),this.addVersion()},e.prototype.setSourceRecords=function(e){var t=this;this.canSaveSource()&&(this.clearRecordsNotAddVersion(),o.lodash.defer((function(){t.setSelectedRecordIdsToInfo([],t.getMainDataSource())})),this.sourceRecords=e.filter((function(e){return!!e})).map((function(e){return e.dataSource=t,e})),this.getAllDerivedDataSources().forEach((function(e){e.clearRecords(),o.lodash.defer((function(){e.setSelectedRecordIdsToInfo([],e.getMainDataSource())}))})),this.addSourceVersion(),this.addVersion())},e.prototype.getSourceRecords=function(){return this.canSaveSource()?this.sourceRecords||[]:this.isLocalViewOfSelectionView()?this.belongToDataSource.getSourceRecords():this.getMainDataSource().getSourceRecords()},e.prototype.canSaveSource=function(){return!this.isDataView&&!this.isLocal||this.isSelectionView()},e.prototype.getSelectionDataView=function(){var e=this.isDataView||this.isLocal?this.getMainDataSource().id:this.id;return this.dataSourceManager.getDataViewDataSource(e,o.CONSTANTS.SELECTION_DATA_VIEW_ID)},e.prototype.getSelectedRecords=function(){var e=this.getSelectionDataView(),t=e?e.getRecords(!1):[],r=this.getSelectedRecordIds();return t.filter((function(e){return r.includes(e.getId())}))},e.prototype.getSelectedRecordIndexes=function(){var e=this;if(!Object(o.getAppStore)().getState().dataSourcesInfo[this.id])return[];var t=this.isDataView||this.isLocal?this.getMainDataSource().id:this.id;return Object(o.getAppStore)().getState().dataSourcesInfo[t].selectedIndexes?Object(o.getAppStore)().getState().dataSourcesInfo[t].selectedIndexes.asMutable():Object(o.getAppStore)().getState().dataSourcesInfo[t].selectedIds?Object(o.getAppStore)().getState().dataSourcesInfo[t].selectedIds.asMutable().map((function(t){return e.getRecords(!1).findIndex((function(e){return e.getId()==t}))})):[]},e.prototype.getSelectedRecordIds=function(){return this.isSelectionView()?this.getMainDataSource().getSelectedRecordIdsFromInfo().asMutable():this.getSelectedRecordIdsFromInfo().asMutable()},e.prototype.nextRecord=function(){if(this.getSelectedRecordIndexes().length>1)return console.warn('method "nextRecord" only works when single record is selected'),null;if(this.getSelectedRecordIndexes().indexOf(this.getRecords(!1).length-1))throw Error("Reach the end of data.");return Object(o.getAppStore)().dispatch(o.appActions.dataSourceSelectedIndexesChanged(this.id,[this.getSelectedRecordIndexes()[0]++])),this.getSelectedRecords()[0]},e.prototype.prevRecord=function(){if(this.getSelectedRecordIndexes().length>1)return console.warn('method "prevRecord" only works when single record is selected'),null;if(this.getSelectedRecordIndexes().indexOf(0))throw Error("Reach the start of data.");return Object(o.getAppStore)().dispatch(o.appActions.dataSourceSelectedIndexesChanged(this.id,[this.getSelectedRecordIndexes()[0]--])),this.getSelectedRecords()[0]},e.prototype.getRecord=function(e){return this.getRecords(!1)[e]},e.prototype.getSourceRecord=function(e){return this.getSourceRecords()[e]},e.prototype.getRecordById=function(e){return this.getRecords(!1).filter((function(t){return t&&t.getId()===e}))[0]},e.prototype.getSourceRecordById=function(e){return this.getSourceRecords().filter((function(t){return t&&t.getId()===e}))[0]},e.prototype.clearSelection=function(){var e=this;this.clearOneDsSelection(this.getMainDataSource()),this.getMainDataSource().getAllDerivedDataSources().forEach((function(t){return e.clearOneDsSelection(t)}))},e.prototype.clearOneDsSelection=function(e){Object(o.getAppStore)().dispatch(o.appActions.dataSourceSelectedIndexesChanged(e.id,null)),Object(o.getAppStore)().dispatch(o.appActions.dataSourceSelectedIdsChanged(e.id,null)),e===this.getMainDataSource()&&(o.jimuHistory.changeQueryObjectByDataRecordIds(e.id,null),o.jimuHistory.changeQueryObjectByDataRecordIndexes(e.id,null),this.copySelectionToDataView([]))},e.prototype.updateSelectionStateAndChangeUrl=function(e,t){var r=this,n=this.getMainDataSource();if("byIndex"===e){var i=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(!1),a=t.map((function(e){var t;return null===(t=i[e])||void 0===t?void 0:t.getId()}));Object(o.getAppStore)().dispatch(o.appActions.dataSourceSelectedIndexesChanged(this.id,t)),n.getAllDerivedDataSources().forEach((function(e){e.id!==r.dataSourceManager.getDataViewDataSourceId(n.id,o.CONSTANTS.SELECTION_DATA_VIEW_ID)&&e.id!==r.dataSourceManager.getDataViewDataSourceId(n.id,o.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION)&&e.id!==r.id&&Object(o.getAppStore)().dispatch(o.appActions.dataSourceSelectedIdsChanged(e.id,a))})),this===n?o.jimuHistory.changeQueryObjectByDataRecordIndexes(this.id,t):(Object(o.getAppStore)().dispatch(o.appActions.dataSourceSelectedIdsChanged(n.id,a)),o.jimuHistory.changeQueryObjectByDataRecordIds(n.id,a))}else"byId"===e&&(n.getAllDerivedDataSources().forEach((function(e){e.id!==r.dataSourceManager.getDataViewDataSourceId(n.id,o.CONSTANTS.SELECTION_DATA_VIEW_ID)&&e.id!==r.dataSourceManager.getDataViewDataSourceId(n.id,o.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION)&&e.setSelectedRecordIdsToInfo(t,r)})),n.setSelectedRecordIdsToInfo(t,this),o.jimuHistory.changeQueryObjectByDataRecordIds(n.id,t))},e.prototype.selectRecord=function(e){var t=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecord(e):this.getRecord(e);this.copySelectionToDataView([t]),this.updateSelectionStateAndChangeUrl("byIndex",[e])},e.prototype.selectRecords=function(e){var t=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(!1),r=e.map((function(e){return t[e]}));this.copySelectionToDataView(r),this.updateSelectionStateAndChangeUrl("byIndex",e)},e.prototype.selectRecordById=function(e,t){var r;this.getSelectedRecordIds().find((function(t){return t===e}))||(r=this.getDataSourceJson().isDataInDataSourceInstance?t||e&&this.getSourceRecordById(e):t||e&&this.getRecordById(e),this.copySelectionToDataView([r]),this.updateSelectionStateAndChangeUrl("byId",[e]))},e.prototype.selectRecordsByIds=function(e,t){var r=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(!1),n=t||e.map((function(e){return r.find((function(t){return(null==t?void 0:t.getId())===e}))}));this.copySelectionToDataView(n),this.updateSelectionStateAndChangeUrl("byId",e)},e.prototype.copySelectionToDataView=function(e){var t=this.getSelectionDataView();t&&(t.setSourceRecords(e.filter((function(e){return!!e}))),t.setRecords(e.filter((function(e){return!!e}))))},e.prototype.getInfo=function(){return Object(o.getAppStore)().getState().dataSourcesInfo[this.id]||Object(o.Immutable)({})},e.prototype.clearRecords=function(){this.clearRecordsNotAddVersion(),this.addVersion()},e.prototype.clearRecordsNotAddVersion=function(){!this.isSelectionView()&&this.getSelectedRecords().length>0&&this.copySelectionToDataView([]),this.records=[]},e.prototype.getIdField=function(){return this.getSchema()&&this.getSchema().idField||"id"},e.prototype.getRootDataSource=function(){if(this.isDataView||this.isLocal)return this.getMainDataSource().getRootDataSource();for(var e=this.parentDataSource;e&&e.parentDataSource;)e=e.parentDataSource;return e},e.prototype.ready=function(){return a(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return[4,Promise.resolve({})];case 1:return[2,e.sent()]}}))}))},e.prototype.getOriginDataSources=function(){var e=this;return this.isDataView||this.isLocal?this.getMainDataSource().getOriginDataSources():this.getDataSourceJson().originDataSources&&0!==this.getDataSourceJson().originDataSources.length?this.getDataSourceJson().originDataSources.asMutable().map((function(t){return e.dataSourceManager.getDataSource(t.dataSourceId)})):[]},e.prototype.getMainDataSource=function(){var e;return this.belongToDataSource?null!==(e=this.belongToDataSource.belongToDataSource)&&void 0!==e?e:this.belongToDataSource:this},e.prototype.getDataViews=function(){var e=this;return this.getMainDataSource()!==this?[]:this.dataSourceManager.getDataSourcesAsArray().filter((function(t){return t.belongToDataSource===e&&t.isDataView}))},e.prototype.getDataView=function(e){return this.getDataViews().find((function(t){return t.dataViewId===e}))},e.prototype.getLocalDataSources=function(){var e=this;return this.isLocal?[]:this.dataSourceManager.getDataSourcesAsArray().filter((function(t){return t.belongToDataSource===e&&t.isLocal}))},e.prototype.getLocalDataSource=function(e){return this.getLocalDataSources().find((function(t){return t.localId===e}))},e.prototype.getAllDerivedDataSources=function(){var e=[],t=this.getDataViews(),r=this.getLocalDataSources();return e=t.concat(r),t.forEach((function(t){e=e.concat(t.getLocalDataSources())})),e},e.prototype.getSaveStatus=function(){var e;return null===(e=Object(o.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.saveStatus},e.prototype.setSaveStatus=function(e){Object(o.getAppStore)().dispatch(o.appActions.dataSourceSaveStatusChanged(this.id,e))},e.prototype.setListenSelection=function(e){this.listenSelection=e},e.prototype.getListenSelection=function(){return this.listenSelection},e.prototype.isSelectionView=function(){return this.isDataView&&this.dataViewId===o.CONSTANTS.SELECTION_DATA_VIEW_ID},e.prototype.isLocalViewOfSelectionView=function(){return this.isLocal&&this.dataViewId===o.CONSTANTS.SELECTION_DATA_VIEW_ID},e.prototype.addRecord=function(e){return a(this,void 0,void 0,(function(){var t=this;return u(this,(function(r){switch(r.label){case 0:return e?[3,2]:[4,Promise.reject("No record passed in.")];case 1:return[2,r.sent()];case 2:return this.setSaveStatus(i.b.Saving),[4,this.doAddRecord(e).then((function(e){return t.setSaveStatus(i.b.Saved),e}),(function(e){return a(t,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return this.setSaveStatus(i.b.SaveError),[4,Promise.reject(e)];case 1:return[2,t.sent()]}}))}))}))];case 3:return[2,r.sent()]}}))}))},e.prototype.doAddRecord=function(e){return a(this,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return this.getDataSourceJson().isDataInDataSourceInstance?[4,this.doAddRecordToSourceRecords(e)]:[3,2];case 1:return[2,t.sent()];case 2:return[4,Promise.reject("Editing source is not ready yet.")];case 3:return[2,t.sent()]}}))}))},e.prototype.updateRecord=function(e){return a(this,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return[4,this.updateRecords([e])];case 1:return[2,t.sent()]}}))}))},e.prototype.updateRecords=function(e){return a(this,void 0,void 0,(function(){var t=this;return u(this,(function(r){switch(r.label){case 0:return e&&0!==e.length?[3,2]:[4,Promise.reject("No records passed in.")];case 1:return[2,r.sent()];case 2:return this.setSaveStatus(i.b.Saving),[4,this.doUpdateRecords(e).then((function(e){return t.setSaveStatus(i.b.Saved),e}),(function(e){return a(t,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return this.setSaveStatus(i.b.SaveError),[4,Promise.reject(e)];case 1:return[2,t.sent()]}}))}))}))];case 3:return[2,r.sent()]}}))}))},e.prototype.doUpdateRecords=function(e){return a(this,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return this.getDataSourceJson().isDataInDataSourceInstance?[4,this.doUpdateRecordsInSourceRecords(e)]:[3,2];case 1:return[2,t.sent()];case 2:return[4,Promise.reject("Editing source is not ready yet.")];case 3:return[2,t.sent()]}}))}))},e.prototype.deleteRecord=function(e){return a(this,void 0,void 0,(function(){var t;return u(this,(function(r){switch(r.label){case 0:return t=this.getRecords(!1)[e],[4,this.deleteOneRecord(t)];case 1:return[2,r.sent()]}}))}))},e.prototype.deleteRecordById=function(e){return a(this,void 0,void 0,(function(){var t;return u(this,(function(r){switch(r.label){case 0:return t=this.getRecordById(e),[4,this.deleteOneRecord(t)];case 1:return[2,r.sent()]}}))}))},e.prototype.deleteOneRecord=function(e){return a(this,void 0,void 0,(function(){var t=this;return u(this,(function(r){switch(r.label){case 0:return e?[3,2]:[4,Promise.reject("No record passed in.")];case 1:return[2,r.sent()];case 2:return this.setSaveStatus(i.b.Saving),[4,this.doDeleteOneRecord(e).then((function(e){return t.setSaveStatus(i.b.Saved),e}),(function(e){return a(t,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return this.setSaveStatus(i.b.SaveError),[4,Promise.reject(e)];case 1:return[2,t.sent()]}}))}))}))];case 3:return[2,r.sent()]}}))}))},e.prototype.doDeleteOneRecord=function(e){return a(this,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return this.getDataSourceJson().isDataInDataSourceInstance?[4,this.doDeleteOneRecordFromSourceRecords(e)]:[3,2];case 1:return[2,t.sent()];case 2:return[4,Promise.reject("Editing source is not ready yet.")];case 3:return[2,t.sent()]}}))}))},e.prototype.doDeleteOneRecordFromSourceRecords=function(e){return a(this,void 0,void 0,(function(){return u(this,(function(t){return this.sourceRecords=this.sourceRecords.filter((function(t){return t.getId()!==e.getId()})),[2,Promise.resolve(!0)]}))}))},e.prototype.doAddRecordToSourceRecords=function(e){return a(this,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return this.sourceRecords=this.sourceRecords.concat(e),[4,Promise.resolve(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.doUpdateRecordsInSourceRecords=function(e){return a(this,void 0,void 0,(function(){var t=this;return u(this,(function(r){return e.forEach((function(e){var r=t.sourceRecords.findIndex((function(t){return t.getId()===e.getId()}));r>-1&&(t.sourceRecords[r]=e)})),[2,Promise.resolve(!0)]}))}))},e.prototype.destroy=function(){},e}(),c=(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),l=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},d=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},h=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.isDataSourceSet=!0,t}return c(t,e),t.prototype.ready=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return[4,this.createChildDataSources()];case 1:return[2,e.sent()]}}))}))},t.prototype.destroy=function(){var e=this;this.getChildDataSources().forEach((function(t){t&&e.dataSourceManager.destroyDataSource(t.id)}))},t.prototype.getChildDataSourceId=function(e){return o.dataSourceUtils.getChildDataSourceId(this.id,e)},t.prototype.getChildDataSources=function(){var e=this;return Object.keys(this.dataSourceManager.getDataSources()).filter((function(t){return e.dataSourceManager.getDataSource(t).parentDataSource===e})).map((function(t){return e.dataSourceManager.getDataSource(t)}))},t.prototype.getChildDataSource=function(e){return this.dataSourceManager.getDataSource(this.getChildDataSourceId(e))},t.prototype.getJimuChildId=function(e){var t=this.getReversedConfigSchema();return t&&t.childSchemas&&t.childSchemas[e]?t.childSchemas[e].map((function(e){return e.jimuChildId})).asMutable():[e]},t}(s),f=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),p=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},y=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},v=function(e){function t(t){var r=e.call(this,t)||this;return t.layer&&(r.layer=t.layer),r}return f(t,e),t.prototype.ready=function(){return p(this,void 0,void 0,(function(){var t=this;return y(this,(function(r){switch(r.label){case 0:return[4,this.fetchServiceDefinition().then((function(){return p(t,void 0,void 0,(function(){return y(this,(function(t){switch(t.label){case 0:return[4,e.prototype.ready.call(this)];case 1:return[2,t.sent()]}}))}))}))];case 1:return[2,r.sent()]}}))}))},t.prototype.fetchSchema=function(){return p(this,void 0,void 0,(function(){var e,t,r;return y(this,(function(n){switch(n.label){case 0:return e=this.getChildDataSources(),[4,o.dataSourceUtils.getOriginDataLabel(this.getServiceDefinition(),this.layer,this.getDataSourceJson())];case 1:return t=n.sent(),r=Object(o.Immutable)({childSchemas:{},label:t}),e.forEach((function(e,t){var n=e.getFetchedSchema();r=r.setIn(["childSchemas",e.jimuChildId],n)})),[2,Promise.resolve(r)]}}))}))},t.prototype.getServiceDefinition=function(){return this.isDataView||this.isLocal?this.getMainDataSource().getServiceDefinition():this.serviceDefinition},t.prototype.createChildDataSourcesByUrl=function(){return p(this,void 0,void 0,(function(){var e,t=this;return y(this,(function(r){return this.childDataSourcesPromise||(e=void 0,this.url&&(e=o.dataSourceUtils.fetchSupportedLayerDefinitions(this.url,this.getServiceDefinition())),this.childDataSourcesPromise=e?e.then((function(e){return p(t,void 0,void 0,(function(){var t,r,n=this;return y(this,(function(i){return t=[],r=[],Object.keys(e).filter((function(t){return o.dataSourceUtils.isLayerDefinitionTypeSupported(e[t])})).forEach((function(i){var a=n.getDsJsonsFromSingleLayerDefinition(o.dataSourceUtils.getDataSourceSourceUrl(i),e[i],r);r=r.concat(a),a.forEach((function(e){var r={id:e.id,dataSourceJson:e,parentDataSource:n,jimuChildId:n.getJimuChildIdFromChildDsId(e.id)};t.push(n.dataSourceManager.createDataSource(r))}))})),[2,Promise.allSettled(t).then((function(e){return e.filter((function(e){return"fulfilled"===e.status})).map((function(e){return e.value}))}))]}))}))})):Promise.resolve([])),[2,this.childDataSourcesPromise]}))}))},t.prototype.fetchServiceDefinitionByUrl=function(){return p(this,void 0,void 0,(function(){var e=this;return y(this,(function(t){switch(t.label){case 0:return this.getServiceDefinition()?[4,Promise.resolve(this.getServiceDefinition())]:[3,2];case 1:return[2,t.sent()];case 2:return this.url?[4,o.ServiceManager.getInstance().fetchServiceInfo(this.url).then((function(e){return e.definition})).then((function(t){return t?(t.name||(t.name=o.dataSourceUtils.getServiceLabelFromUrl(e.url)),e.serviceDefinition=t,e.serviceDefinition):null}))]:[3,4];case 3:return[2,t.sent()];case 4:return[2,Promise.reject("Failed to fetch service definition, need url.")]}}))}))},t.prototype.getDsJsonsFromSingleLayerDefinition=function(e,t,r){var n=this;if(!t)return[];var a,u=[];return this.getJimuChildIdByJSAPILayerOrServiceDefinition(null,t,e,r).forEach((function(r){var s,c,l,d,h=n.getDataSourceJson().schema?null===(s=n.getDataSourceJson().schema.childSchemas)||void 0===s?void 0:s[r]:null,f=n.getChildDataSourceId(r);o.dataSourceUtils.isSupportedSingleLayerService(e)?a=o.dataSourceUtils.getSingleDsJsonFromLayerDefinition(f,e,t,null===(c=n.getDataSourceJson().childDataSourceJsons)||void 0===c?void 0:c[r]):o.dataSourceUtils.isSupportedWholeService(e)?a=o.dataSourceUtils.getSingleDsJsonFromWholeServiceDefinition(f,e,t,null===(l=n.getDataSourceJson().childDataSourceJsons)||void 0===l?void 0:l[r]):e||t.type!==i.f.FeatureLayer||(a=o.dataSourceUtils.getSingleDsJsonFromLayerDefinition(f,e,t,(null===(d=n.getDataSourceJson().childDataSourceJsons)||void 0===d?void 0:d[r])?n.getDataSourceJson().childDataSourceJsons[r]:null)),a&&(n.getDataSourceJson().portalUrl&&(a=a.set("portalUrl",n.getDataSourceJson().portalUrl)),n.getDataSourceJson().itemId&&(a=a.set("itemId",n.getDataSourceJson().itemId)),h&&(a=a.set("schema",h)),u.push(a))})),u},t.prototype.getJimuChildIdFromChildDsId=function(e){return e.split(this.id+"-")[1]},t.prototype.getJimuChildIdByJSAPILayerOrServiceDefinition=function(e,t,r,n){var i,a=this;if(e){var u=o.dataSourceUtils.getFixedLayerIdByLayer(e)||o.dataSourceUtils.getServiceLabelFromUrl(r);i=this.getJimuChildId(u)}else if(t){u=o.dataSourceUtils.getFixedLayerIdByLayerDefinition(t)||o.dataSourceUtils.getServiceLabelFromUrl(r);i=this.getJimuChildId(u)}else i=[];var s={},c=n.map((function(e){return a.getJimuChildIdFromChildDsId(e.id)}));i.forEach((function(e,t){s[e]||(s[e]={isSameAsExistedJimuChildId:c.some((function(t){return t===e})),indexes:[]}),s[e].indexes.push(t)}));var l=[];return Object.keys(s).forEach((function(e){s[e].isSameAsExistedJimuChildId||1!==s[e].indexes.length?!s[e].isSameAsExistedJimuChildId&&s[e].indexes.length>1?s[e].indexes.forEach((function(t){l=0===t?l.concat(e):l.concat(e+"_"+t)})):s[e].isSameAsExistedJimuChildId&&s[e].indexes.forEach((function(t){l=l.concat(e+"_"+(t+1))})):l=l.concat(e)})),l},t}(h),S=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),g=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},m=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},D=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return S(t,e),t.prototype.load=function(){return g(this,void 0,void 0,(function(){var e=this;return m(this,(function(t){switch(t.label){case 0:return this.setStatus(i.b.Loading),[4,this.doLoad().then((function(t){return e.records=t,e.setStatus(i.b.Loaded),e.records}))];case 1:return[2,t.sent()]}}))}))},t}(s),b=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),I=function(){return(I=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},w=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},R=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},P=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r},A=o.CONSTANTS.DEFAULT_QUERY_PAGE_SIZE,O=o.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION,C=o.CONSTANTS.OUTPUT_DATA_VIEW_ID,L=o.CONSTANTS.SELECTION_DATA_VIEW_ID,V=function(e){function t(t){var r=e.call(this,t)||this;r.pages={},r.pagePromises={},r.throttleQueryRecordsByIdWithCurrentQueryParams=o.lodash.throttle(r.queryRecordsByIdWithCurrentQueryParams,200),r.url=r.getDataSourceJson().url;var n=t.belongToDataSource&&t.belongToDataSource.getStatus()!==i.b.NotReady;return r.getDataSourceJson().isOutputFromWidget&&!n?(r.setStatus(i.b.NotReady),r.setCountStatus(i.b.NotReady)):(r.setStatus(i.b.Unloaded),r.setCountStatus(i.b.Unloaded)),r}return b(t,e),t.prototype.ready=function(){var e,t,r=this;if(this.isSelectionView()){var n=this.getMainDataSource().id,i=Object(o.getAppStore)().getState().dataSourcesInfo,a=(null===(t=null===(e=null==i?void 0:i[n])||void 0===e?void 0:e.selectedIds)||void 0===t?void 0:t.asMutable())||[];return i&&Object.keys(i).forEach((function(e){var t,r;if(o.dataSourceUtils.isDerivedFrom(n,e)){var u=(null===(r=null===(t=i[e])||void 0===t?void 0:t.selectedIds)||void 0===r?void 0:r.asMutable())||[];a=a.concat(u)}})),0===(a=Array.from(new Set(a))).map((function(e){return+e})).filter((function(e){return!isNaN(e)})).length?Promise.resolve({}):this.queryRecordsByIdWithCurrentQueryParams(a,this.getMainDataSource()).then((function(e){var t;r.getMainDataSource().selectRecordsByIds(null===(t=e.records)||void 0===t?void 0:t.map((function(e){return e.getId()})),e.records)})).catch((function(e){console.error("Failed set selected records in URL to selection view "+r.id+".",e)}))}return this.isDataView&&this.dataViewId===O?Promise.allSettled([this.load({},{widgetId:O}),this.loadCount({},{widgetId:O})]).then((function(){r.getMainDataSource().addSourceVersion()})):Promise.resolve({})},t.prototype.getCurrentQueryParams=function(e){var t=this.getRuntimeQueryParams(e&&e.dataSourceId===this.id?null==e?void 0:e.widgetId:null);return this.getCurrentQueryParamsByQuery(t,e)},t.prototype.getRuntimeQueryParams=function(e){var t,r=e?null===(t=this.getInfo().widgetQueries)||void 0===t?void 0:t.without(e):this.getInfo().widgetQueries;return this.getMergedWidgetQueries(r)},t.prototype.getCurrentQueryParamsByQuery=function(e,t){var r;return this.isLocal?r=this.mergeQueryParams(this.belongToDataSource.getCurrentQueryParams(t),e):this.isDataView?(r=this.mergeQueryParams(this.getConfigQueryParams(),e),r=this.mergeQueryParams(this.getMainDataSource().getCurrentQueryParams(t),r)):(r=this.mergeQueryParams(this.getConfigQueryParams(),e),r=this.mergeQueryParams(this.getRemoteQueryParams(),r)),r},t.prototype.getMergedWidgetQueries=function(e){var t,r=this,n=e&&Object.keys(e)||[];return(n=n.sort((function(e,t){return e.localeCompare(t)}))).forEach((function(n){t=r.mergeQueryParams(t,e[n])})),t},t.prototype.getCurrentQueryId=function(){return this.lastQueryId},t.prototype.getRealQueryParams=function(e,t,r){var n,a=this;if("query"===t)r&&r.scope?r.scope===i.d.InAllData?n=e:r.scope===i.d.InRemoteConfigView?n=this.mergeQueryParams(this.getRemoteQueryParams(),e):r.scope===i.d.InConfigView?(n=this.mergeQueryWithConfigQuery(e),n=this.mergeQueryParams(this.getRemoteQueryParams(),n)):n=r.scope===i.d.InRuntimeView?this.mergeQueryParams(this.getCurrentQueryParams(r.excludeQuery),e):e:n=this.mergeQueryParams(this.getCurrentQueryParams(null==r?void 0:r.excludeQuery),e);else{if(!r||!r.widgetId)return console.error("Please pass widget id for load."),null;var u=function(){var t,n=a.getInfo().widgetQueries||Object(o.Immutable)({});return(null==r?void 0:r.excludeQuery)&&(n=n.without(r.excludeQuery.widgetId)),n=n.set(r.widgetId,e),t=a.getMergedWidgetQueries(n),t=a.getCurrentQueryParamsByQuery(t,null==r?void 0:r.excludeQuery)};r&&r.scope?r.scope===i.d.InAllData?n=e:r.scope===i.d.InRemoteConfigView?n=this.mergeQueryParams(this.getRemoteQueryParams(),e):r.scope===i.d.InConfigView?(n=this.mergeQueryWithConfigQuery(e),n=this.mergeQueryParams(this.getRemoteQueryParams(),n)):n=r.scope===i.d.InRuntimeView?u():e:n=u()}return n},t.prototype.getDataViewConfig=function(){return this.isLocal?this.belongToDataSource.getDataViewConfig():this.isDataView?this.getDataSourceJson().dataViews&&this.getDataSourceJson().dataViews[this.dataViewId]:this.getDataSourceJson().query},t.prototype.mergeQueryWithConfigQuery=function(e){var t;return this.isLocal?this.belongToDataSource.isDataView?(t=this.mergeQueryParams(this.belongToDataSource.getConfigQueryParams(),e),t=this.mergeQueryParams(this.getMainDataSource().getConfigQueryParams(),t)):t=this.mergeQueryParams(this.getConfigQueryParams(),e):this.isDataView?(t=this.mergeQueryParams(this.getConfigQueryParams(),e),t=this.mergeQueryParams(this.getMainDataSource().getConfigQueryParams(),t)):t=this.mergeQueryParams(this.getConfigQueryParams(),e),t},t.prototype.updateQueryParams=function(e,t){e=this.getQueryWithoutPage(e),o.utils.isDeepEqual(e,this.getInfo().widgetQueries&&this.getInfo().widgetQueries[t])||(Object(o.getAppStore)().dispatch(o.appActions.updateWidgetQuery(this.id,t,e)),this.isSelectionView()&&(this.load({},{widgetId:L}),this.loadCount({},{widgetId:L})))},t.prototype.getQueryPageSize=function(){var e;return(null===(e=this.getDataViewConfig())||void 0===e?void 0:e.pageSize)||A},t.prototype.getMaxRecordCount=function(){var e;return(null===(e=this.getDataViewConfig())||void 0===e?void 0:e.maximum)||null},t.prototype.getQueryWithoutPage=function(e){if(!e)return null;e.pageSize,e.page;return P(e,["pageSize","page"])},t.prototype.checkClearLocalCache=function(e,t,r){var n=this.getQueryWithoutPage(e),i=this.getRealQueryParams(n,"load",r),a=r.refresh||this.getInfo().needRefresh;return!(o.utils.isDeepEqual(i,t)&&!a)},t.prototype.getRecordsByPage=function(e,t,r){if(void 0===r&&(r=!0),r&&this.isSelectionView()&&this.isRealSelectionEmpty()){var n=this.getMainDataSource().getDataView(O);if(n)return n.getRecordsByPage(e,t,!1)}var o=I({},this.pages),i=Object.keys(o).map((function(e){return parseInt(e)})).sort((function(e,t){return t-e}))[0],a=this.getQueryPageSize(),u=t*(e-1),s=u+t-1,c=this.getMaxRecordCount();null!==c&&(u=Math.min(u,c-1),s=Math.min(s,c-1));for(var l=[],d=1;d<=i;d++){var h=(d-1)*a;if(!(h+a-1<u||h>s)&&o[d])for(var f=0;f<o[d].length;f++)h+f<u||h+f>s||l.push(o[d][f])}return l},t.prototype.getRecordsByPageWithSelection=function(e,t){return this.concatRecordsAndSelection(this.getRecordsByPage(e,t),this.getSelectedRecords())},t.prototype.getPagesData=function(){return this.pages},t.prototype.setPagesData=function(e){this.pages=e},t.prototype.clearRecordsNotAddVersion=function(){!this.isSelectionView()&&this.getSelectedRecords().length>0&&this.copySelectionToDataView([]),this.pages={},this.pagePromises={},this.count=null,this.countPromise=null,this.byIdPromise=null},t.prototype.getRecords=function(e){if(void 0===e&&(e=!0),e&&this.isSelectionView()&&this.isRealSelectionEmpty()){var t=this.getMainDataSource().getDataView(O);if(t)return t.getRecords(!1)}return this.getRealRecords()},Object.defineProperty(t.prototype,"count",{get:function(){if(this.isSelectionView()&&this.isRealSelectionEmpty()){var e=this.getMainDataSource().getDataView(O);if(e)return e.count}return this._count},set:function(e){this._count=e},enumerable:!1,configurable:!0}),t.prototype.isRealSelectionEmpty=function(){var e=this;return 0===Object.keys(this.pages).filter((function(t){var r;return(null===(r=e.pages[t])||void 0===r?void 0:r.length)>0})).length},t.prototype.getRealRecords=function(){for(var e=this,t=[],r=[],n=1;n<=Object.keys(this.pages).length&&this.pages[n];n++)r.push(n);return r.forEach((function(r){t=t.concat(e.pages[r])})),null!==this.getMaxRecordCount()&&this.getMaxRecordCount()<t.length?t.slice(0,this.getMaxRecordCount()):t},t.prototype.setRecords=function(e){var t={},r=this.getQueryPageSize();e.forEach((function(e,n){var o=Math.ceil((n+1)/r);t[o]||(t[o]=[]),t[o][(n+1)%r-1]=e})),this.setPagesData(t),this.addVersion()},t.prototype.getRealQueryPages=function(e,t){var r=t*(e-1),n=r+t-1;null!==this.getMaxRecordCount()&&(n=Math.min(n,this.getMaxRecordCount()-1));for(var o=Math.floor(r/this.getQueryPageSize())+1,i=Math.floor(n/this.getQueryPageSize())+1,a=[],u=o;u<=i;u++)a.push(u);return a},t.prototype.load=function(e,t){return void 0===t&&(t={}),w(this,void 0,void 0,(function(){var r,n,a,u,s=this;return R(this,(function(c){switch(c.label){case 0:return this.getStatus()===i.b.NotReady?[2,Promise.resolve([])]:((e=I({},e)).page||(e.page=1),e.pageSize||(e.pageSize=this.getQueryPageSize()),r=this.getRealQueryPages(e.page,e.pageSize),this.checkClearLocalCache(e,this.lastQueryParams,t)&&(Object.keys(this.pages).forEach((function(e){r.includes(parseInt(e))||delete s.pages[e]})),this.pagePromises={},this.count=null,this.countPromise=null),this.updateQueryParams(e,t.widgetId),n=this.getQueryWithoutPage(e),a=this.getRealQueryParams(n,"load",t),(u=r.filter((function(e){return s.pagePromises[e]})).map((function(e){return w(s,void 0,void 0,(function(){return R(this,(function(t){switch(t.label){case 0:return[4,this.pagePromises[e]];case 1:return[2,t.sent()]}}))}))}))).length!==r.length?[3,2]:[4,Promise.all(u).then((function(){return s.getRecordsByPage(e.page,e.pageSize,!1)}))]);case 1:return[2,c.sent()];case 2:return this.lastQueryParams=a,this.setStatus(i.b.Loading),Object(o.getAppStore)().dispatch(o.appActions.setDataNeedRefresh(this.id,!1)),[2,Promise.all(r.map((function(t){return w(s,void 0,void 0,(function(){return R(this,(function(r){switch(r.label){case 0:return[4,this.loadByPage(a,e,t)];case 1:return[2,r.sent()]}}))}))}))).then((function(t){if(!t.find((function(e){return e})))return[];var r=s.isDataView&&s.dataViewId===O,n=s.isSelectionView(),a=s.isLocalViewOfSelectionView();if(!r&&!n&&!a){var u=[],c=s.getDataSourceJson().isDataInDataSourceInstance?s.getSourceRecords():s.getRecords(!1);s.getSelectedRecordIds().length>0?u=s.getSelectedRecordIds().map((function(e){return c.filter((function(t){return t&&t.getId()===e}))[0]})):s.getSelectedRecordIndexes().length>0&&(u=s.getSelectedRecordIndexes().map((function(e){return c[e]}))),u.filter((function(e){return!!e})).length>0&&s.copySelectionToDataView(u)}return s.isSelectionView()&&s.getMainDataSource().updateSelectionStateAndChangeUrl("byId",s.getRecords(!1).map((function(e){return e.getId()}))),s.lastRefreshTime=new Date,s.setStatus(i.b.Loaded),window.jimuConfig.isInBuilder&&Object(o.getAppStore)().getState().appRuntimeInfo.appMode===o.AppMode.Design||s.startAutoRefresh(),s.getRecordsByPage(e.page,e.pageSize,!1)}),(function(e){return console.error(e),s.setStatus(i.b.LoadError),[]}))]}}))}))},t.prototype.loadByPage=function(e,t,r){return w(this,void 0,void 0,(function(){var n,i=this;return R(this,(function(a){switch(a.label){case 0:return this.pagePromises[r]?[4,this.pagePromises[r]]:[3,2];case 1:return[2,a.sent()];case 2:return n=I(I({},e),{page:r,pageSize:this.getQueryPageSize()}),this.pagePromises[r]=this.doQuery(Object(o.Immutable)(n),Object(o.Immutable)(t)).then((function(e){var t=i.getQueryWithoutPage(e.queryParams);return!(!o.utils.isDeepEqual(t,i.lastQueryParams)||"number"==typeof e.sourceVersion&&e.sourceVersion!==i.getSourceVersion())&&(i.pages[e.queryParams.page]=e.records,!0)})),[2,this.pagePromises[r]]}}))}))},t.prototype.loadCount=function(e,t){return void 0===t&&(t={}),w(this,void 0,void 0,(function(){var r,n=this;return R(this,(function(a){return this.getCountStatus()===i.b.NotReady?[2,Promise.resolve(0)]:(!this.checkClearLocalCache(e,this.lastCountQueryParams,t)&&this.countPromise||(r=this.getRealQueryParams(this.getQueryWithoutPage(e),"load",t),this.lastCountQueryParams=r,this.setCountStatus(i.b.Loading),this.countPromise=this.doQueryCount(Object(o.Immutable)(r)).then((function(e){return!o.utils.isDeepEqual(e.queryParams,n.lastCountQueryParams)||"number"==typeof e.sourceVersion&&e.sourceVersion!==n.getSourceVersion()?null:(null===n.getMaxRecordCount()?n.count=e.count:n.count=Math.min(e.count,n.getMaxRecordCount()),n.setCountStatus(i.b.Loaded),n.count)}),(function(e){return w(n,void 0,void 0,(function(){return R(this,(function(t){switch(t.label){case 0:return console.error(e),this.setCountStatus(i.b.LoadError),[4,Promise.reject(e)];case 1:return[2,t.sent()]}}))}))}))),[2,this.countPromise])}))}))},t.prototype.query=function(e,t){return w(this,void 0,void 0,(function(){var r,n=this;return R(this,(function(a){switch(a.label){case 0:return this.getStatus()===i.b.NotReady?[2,Promise.resolve({queryParams:Object(o.Immutable)(e),records:[],fields:[],sourceVersion:this.getSourceVersion()})]:(r=this.getRealQueryParams(e,"query",t),[4,this.doQuery(Object(o.Immutable)(r),Object(o.Immutable)(e)).then((function(e){var t=n.getMaxRecordCount();if(null===t)return e;var r=e.queryParams.page||1,o=e.queryParams.pageSize;return 1!==r&&o?(r-1)*o>t?e.records=[]:(r-1)*o+e.records.length>t&&(e.records=e.records.slice(0,(r-1)*o+e.records.length-t)):e.records.length>t&&(e.records=e.records.slice(0,t)),e}))]);case 1:return[2,a.sent()]}}))}))},t.prototype.queryCount=function(e,t){return w(this,void 0,void 0,(function(){var r,n=this;return R(this,(function(a){switch(a.label){case 0:return this.getCountStatus()===i.b.NotReady?[2,Promise.resolve({queryParams:Object(o.Immutable)(e),count:0,sourceVersion:this.getSourceVersion()})]:(r=this.getRealQueryParams(e,"query",t),[4,this.doQueryCount(Object(o.Immutable)(r)).then((function(e){return null===n.getMaxRecordCount()||(e.count=Math.min(e.count,n.getMaxRecordCount())),e}))]);case 1:return[2,a.sent()]}}))}))},t.prototype.loadById=function(e,t){return w(this,void 0,void 0,(function(){var r=this;return R(this,(function(n){return this.getStatus()===i.b.NotReady?[2,Promise.resolve(null)]:(e===this.lastQueryId&&!t&&this.byIdPromise||(this.lastQueryId=e,this.setStatus(i.b.Loading),this.byIdPromise=this.doQueryById(e).then((function(e){return r.setStatus(i.b.Loaded),e}),(function(e){return console.error(e),r.setStatus(i.b.LoadError),null}))),[2,this.byIdPromise])}))}))},t.prototype.queryById=function(e){return w(this,void 0,void 0,(function(){return R(this,(function(t){switch(t.label){case 0:return this.getStatus()===i.b.NotReady?[2,Promise.resolve(null)]:[4,this.doQueryById(e)];case 1:return[2,t.sent()]}}))}))},t.prototype.getAutoRefreshInterval=function(){var e=this.getMainDataSource(),t=e.getDataViewConfig()&&e.getDataViewConfig().refreshInterval;return 0===t?0:(null==t&&(t=e.getSchema().refreshInterval),t)},t.prototype.getLastRefreshTime=function(){return this.lastRefreshTime},t.prototype.startAutoRefresh=function(){var e=this,t=this.getAutoRefreshInterval();t&&(this.autoRefreshHandle||(Object(o.getAppStore)().dispatch(o.appActions.setDataNeedRefresh(this.id,!1)),this.autoRefreshHandle=setTimeout((function(){Object(o.getAppStore)().dispatch(o.appActions.setDataNeedRefresh(e.id,!0)),e.stopAutoRefresh()}),1e3*t)))},t.prototype.stopAutoRefresh=function(){this.autoRefreshHandle&&(clearTimeout(this.autoRefreshHandle),this.autoRefreshHandle=null)},t.prototype.getMainDataSource=function(){return e.prototype.getMainDataSource.call(this)},t.prototype.getDataViews=function(){return e.prototype.getDataViews.call(this)},t.prototype.getDataView=function(t){return e.prototype.getDataView.call(this,t)},t.prototype.setSelectedRecordIdsToInfo=function(e,t){var r=this;if(e&&(this.getListenSelection()||this.id===(null==t?void 0:t.id))){var n=!this.isLocal&&!this.isDataView,i=this.dataViewId===C;if(n||i||0===e.length)Object(o.getAppStore)().dispatch(o.appActions.dataSourceSelectedIdsChanged(this.id,e));else{var a=this.getRecords(!1),u=[],s=[];e.forEach((function(e){a.some((function(t){return(null==t?void 0:t.getId())===e}))?s=s.concat(e):u=u.concat(e)})),s.length!==e.length?this.throttleQueryRecordsByIdWithCurrentQueryParams(u).then((function(e){var t=u.filter((function(t){var r;return null===(r=null==e?void 0:e.records)||void 0===r?void 0:r.some((function(e){return(null==e?void 0:e.getId())===t}))}));Object(o.getAppStore)().dispatch(o.appActions.dataSourceSelectedIdsChanged(r.id,s.concat(t)))})).catch((function(e){console.error("Failed to check whether selected records in "+r.id+". ",e)})):Object(o.getAppStore)().dispatch(o.appActions.dataSourceSelectedIdsChanged(this.id,e))}}},t.prototype.queryRecordsByIdWithCurrentQueryParams=function(e,t){var r=e.map((function(e){return+e})).filter((function(e){return!isNaN(e)})),n=this.getCurrentQueryParams(),o=this.mergeQueryParams(n,{objectIds:r});return t?t.query(o):this.query(o)},t}(s),F=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),_=function(){function e(){}return e.prototype.getFieldValue=function(e){return this.getData()[e]},e.prototype.getFormattedFieldValue=function(e,t){var r=this.dataSource.getSchema().fields[e];if(!r)return this.getFieldValue(e);if(r.format)switch(r.type){case o.JimuFieldType.Date:return this.formatDateField(this.getFieldValue(e),r.format.dateFormat,t);case o.JimuFieldType.Number:return this.formatNumberField(this.getFieldValue(e),r.format.places,r.format.digitSeparator,t);default:return this.getFieldValue(e)}else switch(r.type){case o.JimuFieldType.Date:return null!==this.getFieldValue(e)&&void 0!==this.getFieldValue(e)?t.formatDate(this.getFieldValue(e)):null;case o.JimuFieldType.Number:return null!==this.getFieldValue(e)&&void 0!==this.getFieldValue(e)?t.formatNumber(this.getFieldValue(e)):null;default:return this.getFieldValue(e)}},e.prototype.convertBeforeMappingDataToData=function(e){var t={},r=this.dataSource.getReversedConfigSchema();return Object.keys(e).forEach((function(n){var o=r&&r.fields&&r.fields[n];o?o.forEach((function(r){t[r.jimuName]=e[n]})):t[n]=e[n]})),t},e.prototype.convertDataToDataBeforeMapping=function(e){var t={},r=this.dataSource.getSchema();return Object.keys(e).forEach((function(n){var o=r&&r.fields&&r.fields[n]?r.fields[n].name:n;t[o]=e[n]})),t},e.prototype.getFormattedData=function(e){var t=this,r={};return Object.keys(this.getData()).forEach((function(n){r[n]=t.getFormattedFieldValue(n,e)})),r},e.prototype.formatDateField=function(e,t,r){if(!e)return null;"number"==typeof e&&(e=new Date(e));var n=o.dateUtils.ESRI_DATE_FORMAT_MAP[t];if(!n)return console.warn("Invalid data format "+t),null;var i=o.dateUtils.formatDate(e,n.datePattern,r);if("date and time"===n.selector){var a=o.dateUtils.formatTime(e,n.timePattern,r),u=r.locale||"en";i=i+(o.dateUtils.DATE_TIME_CONNECTOR[u]||o.dateUtils.DATE_TIME_CONNECTOR.common)+a}return i},e.prototype.formatNumberField=function(e,t,r,n){if(null===e||void 0===typeof e)return null;var o=new Number(e);return r?n.formatNumber(e,{maximumFractionDigits:t,minimumFractionDigits:t}):o.toFixed(t)},e}(),j=function(e){function t(t,r,n){void 0===n&&(n=!0);var o=e.call(this)||this;return o.dataSource=r,o.data=n?o.convertBeforeMappingDataToData(t):t,o}return F(t,e),t.prototype.getData=function(){return this.data},t.prototype.getDataBeforeMapping=function(){return this.convertDataToDataBeforeMapping(this.data)},t.prototype.toJson=function(){return this.data},t.prototype.getId=function(){return this.data.id},t.prototype.setId=function(){},t.prototype.getGeometry=function(){return null},t}(_),T=function(e){Object.assign(this,e)},E=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Q=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},J=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},x=function(e){function t(t,r,n){var o;void 0===n&&(n=!0);var a=e.call(this)||this,u=(null==r?void 0:r.type)===i.c.FeatureLayer&&(null===(o=r)||void 0===o?void 0:o.getAssociatedDataSource());return a.dataSource=u||r,n?(t.attributes=a.convertBeforeMappingDataToData(t.attributes),a.feature=t):a.feature=t,a.fillGeometry(),a}return E(t,e),t.prototype.fillGeometry=function(){var e;if(this.feature.geometry){var t=this.dataSource;this.feature.geometry.spatialReference||(this.feature.geometry.spatialReference=null===(e=t.getLayerDefinition().extent)||void 0===e?void 0:e.spatialReference)}},t.prototype.queryAttachments=function(e){return Q(this,void 0,void 0,(function(){var t,r,n,i=this;return J(this,(function(a){switch(a.label){case 0:return t=null,r=this.dataSource,(t=r&&r.getMainDataSource().url)?[3,2]:[4,Promise.resolve([])];case 1:return[2,a.sent()];case 2:return n={attachmentTypes:e,url:t,featureId:this.getId()},this._queryAllAttachmentsPromise||(this._queryAllAttachmentsPromise=o.dataSourceUtils.queryAllAttachments(n)),[4,this._queryAllAttachmentsPromise.then((function(e){return Q(i,void 0,void 0,(function(){return J(this,(function(t){switch(t.label){case 0:return this.attachmentInfos=e,[4,o.dataSourceUtils.filterAttachments(e,n)];case 1:return[2,t.sent()]}}))}))}))];case 3:return[2,a.sent()]}}))}))},t.prototype.getSymbolPreviewHTML=function(){return Q(this,void 0,void 0,(function(){var e=this;return J(this,(function(t){switch(t.label){case 0:return this._isGraphicFeature()?[3,2]:[4,Promise.resolve(null)];case 1:return[2,t.sent()];case 2:return this._getSymbolPreviewHTMLPromise?[4,this._getSymbolPreviewHTMLPromise]:[3,4];case 3:return[2,t.sent()];case 4:return this._getSymbolPreviewHTMLPromise=Object(o.loadArcGISJSAPIModules)(["esri/symbols/support/symbolUtils"]).then((function(t){return Q(e,void 0,void 0,(function(){var e,r=this;return J(this,(function(n){switch(n.label){case 0:return e=null,[4,(e=t[0]).getDisplayedSymbol(this.feature).then((function(t){return Q(r,void 0,void 0,(function(){var r;return J(this,(function(n){switch(n.label){case 0:return(r=document.createElement("div")).className="w-100 h-100 d-flex justify-content-center align-items-center",[4,e.renderPreviewHTML(t,{node:r})];case 1:return[2,n.sent()]}}))}))}))];case 1:return[2,n.sent()]}}))}))})),[4,this._getSymbolPreviewHTMLPromise];case 5:return[2,t.sent()]}}))}))},t.prototype.getData=function(){return this.feature.attributes},t.prototype.getFormattedFieldValue=function(t,r){var n=this.dataSource,i=n&&n.getLayerDefinition&&n.getLayerDefinition();if(!i)return e.prototype.getFormattedFieldValue.call(this,t,r);var a=o.dataSourceUtils.getDisplayValueForCodedValueOrSubtype(i,t,this.getData());return a.isCodedValueOrSubtype?a.displayValue:e.prototype.getFormattedFieldValue.call(this,t,r)},t.prototype.getDataBeforeMapping=function(){return this.convertDataToDataBeforeMapping(this.getData())},t.prototype.getOriginData=function(){var e=Object.assign({},this.feature);return e.attributes=this.convertDataToDataBeforeMapping(this.getData()),e},t.prototype.toJson=function(){return this.feature},t.prototype.getId=function(){return this.feature.attributes[this.dataSource.getIdField()]+""},t.prototype.setId=function(e){},t.prototype.getGeometry=function(){return"esri.Graphic"===this.feature.declaredClass?this.feature.toJSON().geometry:this.feature.geometry},t.prototype.setFeature=function(e){this.feature=e,this.fillGeometry()},t.prototype.getFeature=function(){return this.feature},t.prototype._isGraphicFeature=function(){var e;return!!(null===(e=null==this?void 0:this.feature)||void 0===e?void 0:e.layer)},t}(_),U=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),M=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},B=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},N=function(e){function t(t){var r=e.call(this,t)||this;return r.type=i.c.CSV,t.dataSourceJson.data?(r.records=t.dataSourceJson.data.asMutable().map((function(e){return new j(e,r)})),r.setStatus(i.b.Loaded)):r.url=t.dataSourceJson.url,r}return U(t,e),t.prototype.doLoad=function(){return M(this,void 0,void 0,(function(){var e=this;return B(this,(function(t){switch(t.label){case 0:return[4,fetch(this.url).then((function(t){return M(e,void 0,void 0,(function(){return B(this,(function(e){switch(e.label){case 0:return[4,t.json()];case 1:return[2,e.sent()]}}))}))})).then((function(t){return t.map((function(t){return new j(t,e)}))}))];case 1:return[2,t.sent()]}}))}))},t}(D),k=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),q=function(){return(q=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},G=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},W=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},z=function(e){function t(t){var r=e.call(this,t)||this;r.type=i.c.FeatureLayer;var n=r.getDataSourceJson();return r.portalUrl=n.portalUrl,r.itemId=n.itemId,r.layerId=n.layerId,r.getDataSourceJson().isDataInDataSourceInstance?(r.url=null,r.itemId=null,r.portalUrl=null,r.layer=null,r.layerId=null):t.layer?r.layer=t.layer:t.belongToDataSource&&t.belongToDataSource.layer&&(r.layer=t.belongToDataSource.layer),t.associatedDataSource&&r.setAssociatedDataSource(t.associatedDataSource),r}return k(t,e),t.prototype.setAssociatedDataSource=function(e){this.associatedDataSource=e},t.prototype.getAssociatedDataSource=function(){return this.associatedDataSource},t.prototype.getIdField=function(){return this.getSchema().idField},t.prototype.getGeometryType=function(){var e;return this.getDataSourceJson().geometryType||(null===(e=this.getLayerDefinition())||void 0===e?void 0:e.geometryType)},t.prototype.setJsonData=function(e){var t=this;this.records=e.map((function(e){return new x(e,t,!1)}))},t.prototype.doQuery=function(e,t){return G(this,void 0,void 0,(function(){var r,n,i=this;return W(this,(function(a){switch(a.label){case 0:return r={queryParams:e,records:[],sourceVersion:this.getSourceVersion()},this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords().length>0?(n=this.getSourceRecords(),[4,o.dataSourceUtils.createFeatureLayerByRecords(this,n,this.getSourceVersion()).then((function(t){var r=t.layer,n=t.sourceVersion;return G(i,void 0,void 0,(function(){var t;return W(this,(function(o){switch(o.label){case 0:return this.layer=r,[4,this.doQueryByLayer(e)];case 1:return t=o.sent(),[2,q(q({},t),{sourceVersion:n})]}}))}))}))]):[3,2]:[3,3];case 1:r=a.sent(),a.label=2;case 2:return[3,9];case 3:return this.layer?[4,this.doQueryByLayer(e)]:[3,5];case 4:return r=a.sent(),[3,9];case 5:return this.url?[4,this.doQueryByUrl(e)]:[3,7];case 6:return r=a.sent(),[3,9];case 7:return[4,this.createLayerByItemId().then((function(){return G(i,void 0,void 0,(function(){return W(this,(function(t){switch(t.label){case 0:return[4,this.doQueryByLayer(e)];case 1:return[2,t.sent()]}}))}))}))];case 8:r=a.sent(),a.label=9;case 9:return[2,r=this.enhanceQueryResult(r,t)]}}))}))},t.prototype.enhanceQueryResult=function(e,t){var r,n,o,i=null===(r=e.records)||void 0===r?void 0:r.slice();if(!i)return e;var a=e.queryParams;if((null==t?void 0:t.outStatistics)&&((null===(n=null==t?void 0:t.orderByFields)||void 0===n?void 0:n.length)>0&&(i=this.sortRecordsByFields(i,t.orderByFields),a=a.set("orderByFields",t.orderByFields)),"number"==typeof(null==t?void 0:t.pageSize))){var u=null!==(o=t.page)&&void 0!==o?o:1;i=this.sliceRecordsByPage(i,t.pageSize,u),a=(a=a.set("pageSize",t.pageSize)).set("page",u)}return q(q({},e),{records:i,queryParams:a})},t.prototype.sliceRecordsByPage=function(e,t,r){var n=t*(r-1),o=n+t;return e.slice(n,o)},t.prototype.sortRecordsByFields=function(e,t){var r=this;return e.filter((function(e){return!!e})).sort((function(e,n){return r.compareRecordsByFields(e,n,t)}))},t.prototype.compareRecordsByFields=function(e,t,r){for(var n,i,a=0,u=0;a<r.length;){var s=r[a].split(" ")[0],c=0;if(r[a].split(" ").length>2)c=0;else if(typeof e.getFieldValue(s)!=typeof t.getFieldValue(s)){var l=null===(i=null===(n=this.getSchema())||void 0===n?void 0:n.fields)||void 0===i?void 0:i[s],d=((null==l?void 0:l.type)||o.JimuFieldType.Number)===o.JimuFieldType.String?"string":"number",h=typeof e.getFieldValue(s)===d,f=typeof t.getFieldValue(s)===d;c=h&&!f?1:!h&&f?-1:0}else{var p=e.getFieldValue(s),y=t.getFieldValue(s);c=this.getCompareValueResult(p,y)}if(0!==(u="DESC"===r[a].split(" ")[1]?-c:c))break;a++}return u},t.prototype.getCompareValueResult=function(e,t){var r=0;return"string"==typeof e&&"string"==typeof t?r=e.localeCompare?e.localeCompare(t):0:"number"==typeof e&&"number"==typeof t&&(r=e-t),r},t.prototype.doQueryCount=function(e){return G(this,void 0,void 0,(function(){var t,r=this;return W(this,(function(n){switch(n.label){case 0:return this.getDataSourceJson().isDataInDataSourceInstance?0===this.getSourceRecords().length?[2,Promise.resolve({queryParams:e,count:0,sourceVersion:this.getSourceVersion()})]:(t=this.getSourceRecords(),[4,o.dataSourceUtils.createFeatureLayerByRecords(this,t,this.getSourceVersion()).then((function(t){var n=t.layer,o=t.sourceVersion;return G(r,void 0,void 0,(function(){var t;return W(this,(function(r){switch(r.label){case 0:return this.layer=n,[4,this.doQueryCountByLayer(e)];case 1:return t=r.sent(),[2,q(q({},t),{sourceVersion:o})]}}))}))}))]):[3,2];case 1:return[2,n.sent()];case 2:return this.layer?[4,this.doQueryCountByLayer(e)]:[3,4];case 3:return[2,n.sent()];case 4:return this.url?[4,this.doQueryCountByUrl(e)]:[3,6];case 5:return[2,n.sent()];case 6:return[4,this.createLayerByItemId().then((function(){return G(r,void 0,void 0,(function(){return W(this,(function(t){switch(t.label){case 0:return[4,this.doQueryCountByLayer(e)];case 1:return[2,t.sent()]}}))}))}))];case 7:return[2,n.sent()]}}))}))},t.prototype.doAddRecordToServerSideSource=function(e){return G(this,void 0,void 0,(function(){var t=this;return W(this,(function(r){switch(r.label){case 0:return this.layer?[4,this.addRecordByLayer(e)]:[3,2];case 1:return[2,r.sent()];case 2:return this.url?[4,this.addRecordByUrl(e)]:[3,4];case 3:return[2,r.sent()];case 4:return[4,this.createLayerByItemId().then((function(){return G(t,void 0,void 0,(function(){return W(this,(function(t){switch(t.label){case 0:return[4,this.addRecordByLayer(e)];case 1:return[2,t.sent()]}}))}))}))];case 5:return[2,r.sent()]}}))}))},t.prototype.doDeleteOneRecordFromServerSideSource=function(e){return G(this,void 0,void 0,(function(){var t=this;return W(this,(function(r){switch(r.label){case 0:return this.layer?[4,this.deleteOneRecordByLayer(e)]:[3,2];case 1:return[2,r.sent()];case 2:return this.url?[4,this.deleteOneRecordByUrl(e)]:[3,4];case 3:return[2,r.sent()];case 4:return[4,this.createLayerByItemId().then((function(){return G(t,void 0,void 0,(function(){return W(this,(function(t){switch(t.label){case 0:return[4,this.deleteOneRecordByLayer(e)];case 1:return[2,t.sent()]}}))}))}))];case 5:return[2,r.sent()]}}))}))},t.prototype.doUpdateRecordsInServerSideSource=function(e){return G(this,void 0,void 0,(function(){var t=this;return W(this,(function(r){switch(r.label){case 0:return this.layer?[4,this.updateRecordsByLayer(e)]:[3,2];case 1:return[2,r.sent()];case 2:return this.url?[4,this.updateRecordsByUrl(e)]:[3,4];case 3:return[2,r.sent()];case 4:return[4,this.createLayerByItemId().then((function(){return G(t,void 0,void 0,(function(){return W(this,(function(t){switch(t.label){case 0:return[4,this.updateRecordsByLayer(e)];case 1:return[2,t.sent()]}}))}))}))];case 5:return[2,r.sent()]}}))}))},t.prototype.doQueryCountByLayer=function(e){return G(this,void 0,void 0,(function(){var t=this;return W(this,(function(r){switch(r.label){case 0:return[4,this.changeJimuQueryToJSAPILayerQuery(e).then((function(r){return G(t,void 0,void 0,(function(){return W(this,(function(t){switch(t.label){case 0:return[4,this.layer.queryFeatureCount(r).then((function(t){return{queryParams:e,count:t}}))];case 1:return[2,t.sent()]}}))}))}))];case 1:return[2,r.sent()]}}))}))},t.prototype.doQueryCountByUrl=function(e){return G(this,void 0,void 0,(function(){var t;return W(this,(function(r){switch(r.label){case 0:return delete(t=this.changeJimuQueryToRestJSQuery(e)).resultRecordCount,delete t.resultOffset,t.returnCountOnly||(t.returnCountOnly=!0),[4,this._q(t).then((function(t){return{queryParams:e,count:t.count}}))];case 1:return[2,r.sent()]}}))}))},t.prototype.doQueryById=function(e){return G(this,void 0,void 0,(function(){return W(this,(function(t){switch(t.label){case 0:return[4,this.doQuery(Object(o.Immutable)({objectIds:[parseInt(e)],returnGeometry:!0}),Object(o.Immutable)({objectIds:[parseInt(e)],returnGeometry:!0})).then((function(e){return e.records[0]}))];case 1:return[2,t.sent()]}}))}))},t.prototype.queryById=function(t){return G(this,void 0,void 0,(function(){return W(this,(function(r){switch(r.label){case 0:return[4,e.prototype.queryById.call(this,t)];case 1:return[2,r.sent()]}}))}))},t.prototype.getConfigQueryParams=function(){var e=this.getDataViewConfig();return e?{where:o.dataSourceUtils.getArcGISSQL(e.where,this).sql,orderByFields:this.getOrderByArray(e.orderBy)}:null},t.prototype.mergeQueryParams=function(e,t){var r;return r=[e&&e.where,t&&t.where].filter((function(e){return e})).join(" and "),q(q(q({},e),t),{where:r})},t.prototype.getCurrentQueryParams=function(t){var r=e.prototype.getCurrentQueryParams.call(this,t);return this.applyGDBVersionAndFix(r)},t.prototype.getRealQueryParams=function(t,r,n){var o=e.prototype.getRealQueryParams.call(this,t,r,n);return this.applyGDBVersionAndFix(o)},t.prototype.getRemoteQueryParams=function(){return this.getSchema().filter?{where:this.getSchema().filter}:null},t.prototype.applyGDBVersionAndFix=function(e){return this.getGDBVersion()&&(e.gdbVersion=this.getGDBVersion()),e=this.fixQueryParam(Object(o.Immutable)(e)).asMutable({deep:!0})},t.prototype.fixQueryParam=function(e){var t=e;return e.outStatistics&&Object.keys(e).forEach((function(e){["groupByFieldsForStatistics","time","where","outStatistics","geometry","gdbVersion"].includes(e)||(t=t.without(e))})),t},t.prototype.addRecordByLayer=function(e){return G(this,void 0,void 0,(function(){var t,r,n=this;return W(this,(function(i){switch(i.label){case 0:return[4,o.dataSourceUtils.changeToJSAPIGraphic(e.feature)];case 1:return t=i.sent(),r=t.clone(),[4,this.layer.applyEdits({addFeatures:[r]}).then((function(e){var t,o,i=null===(t=e.addFeatureResults[0])||void 0===t?void 0:t.objectId;if("number"!=typeof i||(null===(o=e.addFeatureResults[0])||void 0===o?void 0:o.error))return Promise.reject("Adding record failed.");var a=n.getIdField();return r.attributes[a]=i,new x(r,n)}))];case 2:return[2,i.sent()]}}))}))},t.prototype.addRecordByUrl=function(e){return G(this,void 0,void 0,(function(){var t,r,n,i=this;return W(this,(function(a){switch(a.label){case 0:return t=o.dataSourceUtils.changeToRestAPIFeature(e.feature),r=q({},t),n={url:this.url,features:[r]},[4,o.ServiceManager.getInstance().fetchArcGISServerInfo(this.url).then((function(e){return G(i,void 0,void 0,(function(){var t=this;return W(this,(function(i){switch(i.label){case 0:return[4,o.requestUtils.requestWrapper(this.url,(function(e){return G(t,void 0,void 0,(function(){var t=this;return W(this,(function(i){switch(i.label){case 0:return n.authentication=e,[4,o.esri.restFeatureLayer.addFeatures(n).then((function(e){var n,o,i=null===(n=e.addResults[0])||void 0===n?void 0:n.objectId;if("number"!=typeof i||!(null===(o=e.addResults[0])||void 0===o?void 0:o.success))return Promise.reject("Adding record failed.");var a=t.getIdField();return r.attributes[a]=i,new x(r,t)}))];case 1:return[2,i.sent()]}}))}))}),1,null==e?void 0:e.owningSystemUrl)];case 1:return[2,i.sent()]}}))}))}))];case 1:return[2,a.sent()]}}))}))},t.prototype.updateRecordsByLayer=function(e){return G(this,void 0,void 0,(function(){var t,r=this;return W(this,(function(n){switch(n.label){case 0:return[4,Promise.all(e.map((function(e){return G(r,void 0,void 0,(function(){return W(this,(function(t){switch(t.label){case 0:return[4,o.dataSourceUtils.changeToJSAPIGraphic(e.feature).then((function(e){return e.clone()}))];case 1:return[2,t.sent()]}}))}))})))];case 1:return t=n.sent(),[2,this.layer.applyEdits({updateFeatures:t}).then((function(e){return e.updateFeatureResults.filter((function(e){return!e.error})).length>0}))]}}))}))},t.prototype.updateRecordsByUrl=function(e){return G(this,void 0,void 0,(function(){var t,r,n=this;return W(this,(function(i){return t=e.map((function(e){return q({},o.dataSourceUtils.changeToRestAPIFeature(e.feature))})),r={url:this.url,features:t},[2,o.ServiceManager.getInstance().fetchArcGISServerInfo(this.url).then((function(e){return G(n,void 0,void 0,(function(){var t=this;return W(this,(function(n){switch(n.label){case 0:return[4,o.requestUtils.requestWrapper(this.url,(function(e){return G(t,void 0,void 0,(function(){return W(this,(function(t){switch(t.label){case 0:return r.authentication=e,[4,o.esri.restFeatureLayer.updateFeatures(r).then((function(e){return e.updateResults.filter((function(e){return e.success})).length>0}))];case 1:return[2,t.sent()]}}))}))}),1,null==e?void 0:e.owningSystemUrl)];case 1:return[2,n.sent()]}}))}))}))]}))}))},t.prototype.deleteOneRecordByLayer=function(e){return G(this,void 0,void 0,(function(){var t,r;return W(this,(function(n){switch(n.label){case 0:return[4,o.dataSourceUtils.changeToJSAPIGraphic(e.feature)];case 1:return t=n.sent(),r=t.clone(),[4,this.layer.applyEdits({deleteFeatures:[r]}).then((function(e){return e.deleteFeatureResults.filter((function(e){return!e.error})).length>0}))];case 2:return[2,n.sent()]}}))}))},t.prototype.deleteOneRecordByUrl=function(e){return G(this,void 0,void 0,(function(){var t,r,n,i,a=this;return W(this,(function(u){switch(u.label){case 0:return t=q({},o.dataSourceUtils.changeToRestAPIFeature(e.feature)),r=this.getIdField(),n=t.attributes[r],i={url:this.url,objectIds:[n]},[4,o.ServiceManager.getInstance().fetchArcGISServerInfo(this.url).then((function(e){return G(a,void 0,void 0,(function(){var t=this;return W(this,(function(r){switch(r.label){case 0:return[4,o.requestUtils.requestWrapper(this.url,(function(e){return G(t,void 0,void 0,(function(){return W(this,(function(t){switch(t.label){case 0:return i.authentication=e,[4,o.esri.restFeatureLayer.deleteFeatures(i).then((function(e){return e.deleteResults.filter((function(e){return e.success})).length>0}))];case 1:return[2,t.sent()]}}))}))}),1,null==e?void 0:e.owningSystemUrl)];case 1:return[2,r.sent()]}}))}))}))];case 1:return[2,u.sent()]}}))}))},t.prototype.fetchSchema=function(){return G(this,void 0,void 0,(function(){return W(this,(function(e){switch(e.label){case 0:return this.getDataSourceJson().isStatistic?[4,Promise.resolve(Object(o.Immutable)({}))]:[3,2];case 1:return[2,e.sent()];case 2:return this.layer?[4,this.fetchSchemaWithLayer()]:[3,4];case 3:return[2,e.sent()];case 4:return[4,this.fetchSchemaWithoutLayer()];case 5:return[2,e.sent()]}}))}))},t.prototype.createLayerByItemId=function(){return G(this,void 0,void 0,(function(){var e=this;return W(this,(function(t){switch(t.label){case 0:return this.createFeatureLayerPromise?[4,this.createFeatureLayerPromise]:[3,2];case 1:return[2,t.sent()];case 2:return this.layer?this.createFeatureLayerPromise=Promise.resolve(this.layer):this.itemId&&(this.createFeatureLayerPromise=Object(o.loadArcGISJSAPIModules)(["esri/layers/Layer","esri/portal/PortalItem"]).then((function(t){return G(e,void 0,void 0,(function(){var e,r;return W(this,(function(n){switch(n.label){case 0:return e=t[0],r=t[1],[4,e.fromPortalItem({portalItem:new r({id:this.itemId,portal:{url:this.portalUrl}})})];case 1:return[2,n.sent()]}}))}))})).then((function(t){return G(e,void 0,void 0,(function(){var e=this;return W(this,(function(r){switch(r.label){case 0:return(null==t?void 0:t.type)!==i.g.FeatureLayer?[3,2]:(this.layer=t,[4,Promise.resolve(this.layer)]);case 1:return[2,r.sent()];case 2:return(null==t?void 0:t.type)!==i.g.GroupLayer?[3,4]:[4,t.loadAll().then((function(t){return G(e,void 0,void 0,(function(){var e,r=this;return W(this,(function(n){return(null==(e=t.layers.toArray().find((function(e){return""+e.layerId===r.layerId||o.dataSourceUtils.fixLayerId(e.title||e.id)===r.jimuChildId})))?void 0:e.type)===i.g.FeatureLayer?(this.layer=e,[2,Promise.resolve(this.layer)]):[2,Promise.reject("Feaure layer data source error: failed to create feature layer with specific layer id.")]}))}))}))];case 3:return[2,r.sent()];case 4:return[2]}}))}))}))),[2,this.createFeatureLayerPromise]}}))}))},t.prototype.fetchSchemaWithoutLayer=function(){return G(this,void 0,void 0,(function(){var e=this;return W(this,(function(t){switch(t.label){case 0:return[4,(this.url?o.ServiceManager.getInstance().fetchServiceInfo(this.url):Promise.resolve(null)).then((function(t){return e.itemId?o.requestUtils.requestWrapper(e.getDataSourceJson().portalUrl,(function(r){return G(e,void 0,void 0,(function(){var e=this;return W(this,(function(n){switch(n.label){case 0:return[4,Promise.all([o.esri.restPortal.getItemData(this.itemId,{portal:o.portalUrlUtils.getPortalRestUrl(this.portalUrl),authentication:r}),o.esri.restPortal.getItem(this.itemId,{portal:o.portalUrlUtils.getPortalRestUrl(this.portalUrl),authentication:r})]).then((function(r){var n,o=r[0],i=r[1],a=o&&o.layers&&o.layers[e.layerId],u=(null==t?void 0:t.definition)?e.getUpdatedLayerDefinition(a,t.definition):null==a?void 0:a.layerDefinition;return!e.parentDataSource&&u&&(u.name=(null==i?void 0:i.title)||u.name),{serviceDefinition:u,fieldInfos:a&&a.popupInfo&&a.popupInfo.fieldInfos,filter:(null===(n=null==a?void 0:a.layerDefinition)||void 0===n?void 0:n.definitionExpression)?"("+a.layerDefinition.definitionExpression+")":null,refreshInterval:60*(null==a?void 0:a.refreshInterval)}}))];case 1:return[2,n.sent()]}}))}))})):{serviceDefinition:null==t?void 0:t.definition,fieldInfos:null,filter:null,refreshInterval:null}})).then((function(t){var r,n,i,a,u=t.serviceDefinition,s=t.fieldInfos,c=t.filter,l=t.refreshInterval,d={fields:{},idField:(null==u?void 0:u.idField)||(null===(n=null===(r=null==u?void 0:u.fields)||void 0===r?void 0:r.find((function(e){return"esriFieldTypeOID"===e.type})))||void 0===n?void 0:n.name)||"OBJECTID",filter:c,refreshInterval:l,label:(null===(i=e.layer)||void 0===i?void 0:i.title)||(null==u?void 0:u.name)};return e.layerDefinition=u,null===(a=null==u?void 0:u.fields)||void 0===a||a.forEach((function(e){var t=s&&s.find((function(t){return t.fieldName===e.name}));d.fields[e.name]=o.dataSourceUtils.convertFieldToJimuField(e,t)})),Object(o.Immutable)(d)}))];case 1:return[2,t.sent()]}}))}))},t.prototype.fetchSchemaWithLayer=function(){return G(this,void 0,void 0,(function(){var e=this;return W(this,(function(t){switch(t.label){case 0:return[4,this.layer.load().then((function(){var t,r;e.updateLayerDefinitionByLayer();var n={fields:{},idField:e.layer.objectIdField||(null===(r=null===(t=e.layer.fields)||void 0===t?void 0:t.find((function(e){return"oid"===e.type})))||void 0===r?void 0:r.name)||"OBJECTID",filter:e.layer.definitionExpression?"("+e.layer.definitionExpression+")":null,refreshInterval:60*e.layer.refreshInterval,label:e.layer.title};return e.layer.fields.forEach((function(t){var r=e.layer.popupTemplate&&e.layer.popupTemplate.fieldInfos&&e.layer.popupTemplate.fieldInfos.find((function(e){return e.fieldName===t.name}));r&&(r=r.toJSON()),n.fields[t.name]=o.dataSourceUtils.convertFieldToJimuField(t.toJSON(),r)})),Object(o.Immutable)(n)}))];case 1:return[2,t.sent()]}}))}))},t.prototype.updateLayerDefinitionByLayer=function(){var e=this.layer.sourceJSON,t=this.layer.renderer;if(t&&t.toJSON()){var r=t.toJSON();if("uniqueValue"===r.type){var n=this.layer.sourceJSON.types;r.field1!==this.layer.sourceJSON.typeIdField&&(n=[],r.uniqueValueInfos.map((function(e){n.push({id:e.value,name:e.label,domain:{}})}))),e=Object.assign({name:this.layer.title},e,{drawingInfo:{renderer:r},typeIdField:r.field1,types:n})}}this.layerDefinition=e},t.prototype.getLayerDefinition=function(){return o.dataSourceUtils.getLayerDefinition(this)},t.prototype.getFieldCodedValueList=function(e,t){var r="",n=this.getSchema().fields;return Object.keys(n).some((function(t){return t===e&&(r=n[t].name,!0)})),o.dataSourceUtils.getCodedValueListForCodedValueOrSubtypeField(this.getLayerDefinition(),r,t)},t.prototype.getGDBVersion=function(){return this.getInfo().gdbVersion},t.prototype.changeGDBVersion=function(e){Object(o.getAppStore)().dispatch(o.appActions.changeDataSourceGDBVersion(this.id,e)),this.layer&&(this.layer.gdbVersion=e)},t.prototype.getUpdatedLayerDefinition=function(e,t){var r=t;if(e&&e.layerDefinition){var n=void 0,o=e.layerDefinition.drawingInfo;if(o){if(o.renderer&&"uniqueValue"===o.renderer.type){var i=t.types;o.renderer.field1!==t.typeIdField&&(i=[],o.renderer.uniqueValueInfos.map((function(e){i.push({id:e.value,name:e.label,domain:{}})}))),n={defaultVisibility:e.layerDefinition.defaultVisibility,drawingInfo:e.layerDefinition.drawingInfo,typeIdField:o.renderer.field1,types:i}}}else e.layerDefinition.defaultVisibility!==t.defaultVisibility&&(n={defaultVisibility:e.layerDefinition.defaultVisibility});r=Object.assign({},r,n)}return r},t.prototype.getOrderByArray=function(e){var t;return null!==(t=null==e?void 0:e.map((function(e){return e.jimuFieldName+" "+e.order})).asMutable())&&void 0!==t?t:[]},t.prototype.changeJimuQueryToRestJSQuery=function(e){var t;if(!e)return null;var r=this.fixQueryParam(e).asMutable({deep:!0});if("number"==typeof r.pageSize){var n=null!==(t=r.page)&&void 0!==t?t:1;r.resultOffset=(n-1)*r.pageSize,r.resultRecordCount=r.pageSize,null!==this.getMaxRecordCount()&&(1===n?r.resultRecordCount=Math.min(this.getMaxRecordCount(),r.pageSize):n*r.pageSize>this.getMaxRecordCount()&&(r.resultRecordCount=this.getMaxRecordCount()-(n-1)*r.pageSize)),delete r.page,delete r.pageSize}return Array.isArray(r.orderByFields)&&(r.orderByFields=r.orderByFields.join(",")),Array.isArray(r.groupByFieldsForStatistics)&&(r.groupByFieldsForStatistics=r.groupByFieldsForStatistics.join(",")),r},t.prototype.changeJimuQueryToJSAPILayerQuery=function(e){return G(this,void 0,void 0,(function(){return W(this,(function(t){return[2,o.dataSourceUtils.changeJimuFeatureLayerQueryToJSAPILayerQuery(this,e)]}))}))},t.prototype.doQueryByUrl=function(e){var t;return G(this,void 0,void 0,(function(){var r,n,o=this;return W(this,(function(i){switch(i.label){case 0:return(r=this.changeJimuQueryToRestJSQuery(e)).returnCountOnly?(console.error("To query count, please use queryCount."),[4,Promise.reject("To query count, please use queryCount.")]):[3,2];case 1:return[2,i.sent()];case 2:return r.outFields&&"*"!==r.outFields&&"*"!==r.outFields[0]&&(n=null===(t=this.getLayerDefinition())||void 0===t?void 0:t.typeIdField)&&!r.outFields.includes(n)&&r.outFields.push(n),[4,this._q(r).then((function(t){var r=Object.keys(o.getSchema().fields).filter((function(e){return t.fields&&t.fields.find((function(t){return t.name===o.getSchema().fields[e].name}))}));return{queryParams:e,fields:r,records:t.features.map((function(e){return new x(e,o)}))}}))];case 3:return[2,i.sent()]}}))}))},t.prototype.doQueryByLayer=function(e){return G(this,void 0,void 0,(function(){var t=this;return W(this,(function(r){switch(r.label){case 0:return[4,this.changeJimuQueryToJSAPILayerQuery(e).then((function(r){return G(t,void 0,void 0,(function(){var t,n,o,i=this;return W(this,(function(a){switch(a.label){case 0:return(t=r).outFields&&"*"!==t.outFields[0]&&(n=null===(o=this.getLayerDefinition())||void 0===o?void 0:o.typeIdField)&&!t.outFields.includes(n)&&t.outFields.push(n),[4,this.layer.queryFeatures(t).then((function(t){var r=t.features.map((function(e){return new x(e,i)})),n=Object.keys(i.getSchema().fields).filter((function(e){return t.fields&&t.fields.find((function(t){return t.name===i.getSchema().fields[e].name}))}));return{queryParams:e,records:r,fields:n}}))];case 1:return[2,a.sent()]}}))}))}))];case 1:return[2,r.sent()]}}))}))},t.prototype._q=function(e){return G(this,void 0,void 0,(function(){var t,r=this;return W(this,(function(n){switch(n.label){case 0:return t=q({url:this.url},e),[4,o.ServiceManager.getInstance().fetchArcGISServerInfo(this.url).then((function(e){return G(r,void 0,void 0,(function(){var r=this;return W(this,(function(n){switch(n.label){case 0:return[4,o.requestUtils.requestWrapper(this.url,(function(e){return G(r,void 0,void 0,(function(){return W(this,(function(r){switch(r.label){case 0:return t.authentication=e,[4,o.esri.restFeatureLayer.queryFeatures(t)];case 1:return[2,r.sent()]}}))}))}),1,null==e?void 0:e.owningSystemUrl)];case 1:return[2,n.sent()]}}))}))}))];case 1:return[2,n.sent()]}}))}))},t.prototype.allowToExportData=function(){var e,t,r;if(this.isDataView||this.isLocal)return this.getMainDataSource().allowToExportData();if(this.getDataSourceJson().isOutputFromWidget&&1===(null===(e=this.getDataSourceJson().originDataSources)||void 0===e?void 0:e.length)){var n=null===(t=this.getDataSourceJson().originDataSources[0])||void 0===t?void 0:t.dataSourceId,o=n&&this.dataSourceManager.getDataSource(n);return o?o.allowToExportData():(console.error("Origin data source is not created, allow to export data by default. Output data source id is ",this.id),Promise.resolve(!0))}return!this.getDataSourceJson().disableExport?null!==(r=this.allowExportRemoteCheckPromise)&&void 0!==r?r:this.allowToExportDataInRemote():Promise.resolve(!1)},t.prototype.allowToExportDataInRemote=function(){return G(this,void 0,void 0,(function(){var e=this;return W(this,(function(t){return this.allowExportRemoteCheckPromise=o.dataSourceUtils.isDataSourceSubscriberOrPremium(this.getDataSourceJson()).then((function(t){return!t&&e.allowToExportDataInItem()})),[2,this.allowExportRemoteCheckPromise]}))}))},t.prototype.allowToExportDataInItem=function(){return G(this,void 0,void 0,(function(){var e,t,r,n,i;return W(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),this.itemId?(e=Object(o.getAppStore)().getState().portalUrl,[4,o.esri.restPortal.getItem(this.itemId,{portal:o.portalUrlUtils.getPortalRestUrl(e),authentication:o.SessionManager.getInstance().getMainSession()})]):[2,!0];case 1:return t=a.sent(),r=Object(o.getAppStore)().getState().user,n="org_admin"===(null==r?void 0:r.role),r&&"self"===(null==t?void 0:t.contentOrigin)&&(n||r&&(null==t?void 0:t.owner)===r.username)?[2,!0]:[2,this.getWhetherAllowToExportInItemSetting()];case 2:return i=a.sent(),console.log("Failed to get whether data source "+this.id+" allows to export data, ",i),[2,!0];case 3:return[2]}}))}))},t.prototype.getWhetherAllowToExportInItemSetting=function(){var e;return G(this,void 0,void 0,(function(){var t,r=this;return W(this,(function(n){switch(n.label){case 0:return this.url?[4,o.requestUtils.requestWrapper(this.url,(function(e){return G(r,void 0,void 0,(function(){return W(this,(function(t){switch(t.label){case 0:return[4,o.esri.restRequest.request(this.url,{authentication:e,httpMethod:"GET"})];case 1:return[2,t.sent()]}}))}))}),1)]:[3,2];case 1:return t=n.sent(),[2,!!(null===(e=null==t?void 0:t.capabilities)||void 0===e?void 0:e.includes("Extract"))];case 2:return[2,!0]}}))}))},t.prototype.getPopupInfo=function(){return G(this,void 0,void 0,(function(){return W(this,(function(e){switch(e.label){case 0:return[4,o.dataSourceUtils.getPopupInfo(this)];case 1:return[2,e.sent()]}}))}))},t.prototype.supportSymbol=function(){return o.dataSourceUtils.supportSymbol(this)},t.prototype.supportAttachment=function(){return o.dataSourceUtils.supportAttachment(this)},Object.defineProperty(t.prototype,"layer",{get:function(){var e,t,r;if(this.getDataSourceJson().isOutputFromWidget&&!this.getDataSourceJson().isDataInDataSourceInstance&&1===(null===(e=this.getDataSourceJson().originDataSources)||void 0===e?void 0:e.length)){var n=null===(t=this.getDataSourceJson().originDataSources[0])||void 0===t?void 0:t.dataSourceId,o=n&&this.dataSourceManager.getDataSource(n);if((null==o?void 0:o.type)===i.c.FeatureLayer&&(null==o?void 0:o.layer))return o.layer;if((null==o?void 0:o.type)===i.c.SceneLayer&&(null===(r=null==o?void 0:o.getAssociatedDataSource())||void 0===r?void 0:r.layer))return o.getAssociatedDataSource().layer}return this._layer},set:function(e){this._layer=e},enumerable:!1,configurable:!0}),t}(V),H=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Y=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},Z=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},K=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=i.c.FeatureService,t}return H(t,e),t.prototype.fetchServiceDefinition=function(){return Y(this,void 0,void 0,(function(){return Z(this,(function(e){switch(e.label){case 0:return[4,this.fetchServiceDefinitionByUrl()];case 1:return[2,e.sent()]}}))}))},t.prototype.createChildDataSources=function(){return Y(this,void 0,void 0,(function(){return Z(this,(function(e){switch(e.label){case 0:return[4,this.createChildDataSourcesByUrl()];case 1:return[2,e.sent()]}}))}))},t}(v),X=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),$=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},ee=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},te=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=i.c.GroupLayer,t}return X(t,e),t.prototype.fetchServiceDefinition=function(){return $(this,void 0,void 0,(function(){return ee(this,(function(e){switch(e.label){case 0:return this.url?[4,this.fetchServiceDefinitionByUrl()]:[3,2];case 1:return[2,e.sent()];case 2:return this.layer?[4,Promise.resolve(this.getServiceDefinitionByLayer())]:[3,4];case 3:return[2,e.sent()];case 4:return this.getDataSourceJson().itemId?[4,this.fetchServiceDefnitionByItem()]:[3,6];case 5:return[2,e.sent()];case 6:return[4,Promise.reject("Failed to fetch service definition, need url or layer or item id.")];case 7:return[2,e.sent()]}}))}))},t.prototype.createChildDataSources=function(){return $(this,void 0,void 0,(function(){return ee(this,(function(e){switch(e.label){case 0:return this.layer?[4,this.createChildDataSourcesByLayer()]:[3,2];case 1:return[2,e.sent()];case 2:return this.url?[4,this.createChildDataSourcesByUrl()]:[3,4];case 3:return[2,e.sent()];case 4:return this.getDataSourceJson().itemId?[4,this.createChildDataSourcesByItem()]:[3,6];case 5:return[2,e.sent()];case 6:return[4,Promise.reject("Failed to create child data source, need url or layer or item id.")];case 7:return[2,e.sent()]}}))}))},t.prototype.createChildDataSourcesByLayer=function(){return $(this,void 0,void 0,(function(){var e,t,r,n,a=this;return ee(this,(function(u){return this.childDataSourcesPromise||(e=this.layer.type===i.g.GroupLayer,t=void 0,e?(r=this.layer,t=r.loadAll().then((function(){return $(a,void 0,void 0,(function(){var e,t,n=this;return ee(this,(function(a){switch(a.label){case 0:return e=(null===(t=r.layers)||void 0===t?void 0:t.toArray())||[],[4,Promise.allSettled(e.filter((function(e){return o.dataSourceUtils.isJSAPILayerTypeSupported(e)})).map((function(e){return $(n,void 0,void 0,(function(){var t,r,n,a;return ee(this,(function(u){switch(u.label){case 0:return e.type!==i.g.SceneLayer?[3,5]:e.associatedLayer?[4,Promise.resolve(e)]:[3,2];case 1:return[2,u.sent()];case 2:return t=e,[4,o.dataSourceUtils.fetchAssociatedFeatureLayerUrl(o.dataSourceUtils.getUrlByLayer(t),""+t.layerId,null===(r=t.portalItem)||void 0===r?void 0:r.id,null===(a=null===(n=t.portalItem)||void 0===n?void 0:n.portal)||void 0===a?void 0:a.url).then((function(e){return e?t:Promise.reject("Scene layer does not have associated layer")}))];case 3:return[2,u.sent()];case 4:return[3,6];case 5:return[2,Promise.resolve(e)];case 6:return[2]}}))}))}))).then((function(e){return e.filter((function(e){return"fulfilled"===e.status})).map((function(e){return e.value}))})).then((function(e){return $(n,void 0,void 0,(function(){var t=this;return ee(this,(function(r){switch(r.label){case 0:return[4,Promise.allSettled(e.map((function(e){return $(t,void 0,void 0,(function(){return ee(this,(function(t){switch(t.label){case 0:return[4,this.fetchLayerDefinitionFromLayer(e)];case 1:return[2,t.sent()]}}))}))})))];case 1:return[2,r.sent()]}}))}))})).then((function(e){return e.filter((function(e){return"fulfilled"===e.status})).map((function(e){return e.value})).filter((function(e){return o.dataSourceUtils.isLayerDefinitionTypeSupported(e.def)||o.dataSourceUtils.isJSAPILayerTypeSupported(e.layer)}))}))];case 1:return[2,a.sent()]}}))}))}))):(n=this.layer,t=n.load().then((function(){return $(a,void 0,void 0,(function(){var e,t,r=this;return ee(this,(function(i){switch(i.label){case 0:return e=(null===(t=n.sublayers)||void 0===t?void 0:t.toArray())||[],[4,Promise.allSettled(e.map((function(e){return $(r,void 0,void 0,(function(){return ee(this,(function(t){switch(t.label){case 0:return[4,this.fetchLayerDefinitionFromLayer(e)];case 1:return[2,t.sent()]}}))}))}))).then((function(e){var t=e.filter((function(e){return"fulfilled"===e.status})).map((function(e){return e.value})),r=[];return t.forEach((function(e){o.dataSourceUtils.isLayerDefinitionTypeSupported(e.def)&&(r=r.concat(e))})),r}))];case 1:return[2,i.sent()]}}))}))}))),this.childDataSourcesPromise=t.then((function(e){return $(a,void 0,void 0,(function(){var t,r,n=this;return ee(this,(function(i){return t=[],r=[],e.forEach((function(e){var i=o.dataSourceUtils.getDataSourceSourceUrl(e.url),a=e.def?n.getDsJsonsFromSingleLayerDefinition(i,e.def,r):n.getDsJsonsFromSingleLayer(i,e.layer,r);r=r.concat(a),a.forEach((function(r){var o={id:r.id,dataSourceJson:r,parentDataSource:n,jimuChildId:n.getJimuChildIdFromChildDsId(r.id),layer:e.layer};t.push(n.dataSourceManager.createDataSource(o))}))})),[2,Promise.allSettled(t).then((function(e){return e.filter((function(e){return"fulfilled"===e.status})).map((function(e){return e.value}))}))]}))}))}))),[2,this.childDataSourcesPromise]}))}))},t.prototype.createChildDataSourcesByItem=function(){return $(this,void 0,void 0,(function(){var e,t=this;return ee(this,(function(r){return this.childDataSourcesPromise||(e=o.requestUtils.requestWrapper(this.getDataSourceJson().portalUrl,(function(e){return $(t,void 0,void 0,(function(){return ee(this,(function(t){switch(t.label){case 0:return[4,o.esri.restPortal.getItemData(this.getDataSourceJson().itemId,{portal:o.portalUrlUtils.getPortalRestUrl(this.getDataSourceJson().portalUrl),authentication:e}).then((function(e){var t;return((null===(t=null==e?void 0:e.layers)||void 0===t?void 0:t.map((function(e){return e.layerDefinition})))||[]).filter((function(e){return e.type===i.f.FeatureLayer}))}))];case 1:return[2,t.sent()]}}))}))})),this.childDataSourcesPromise=e.then((function(e){return $(t,void 0,void 0,(function(){var t,r,n=this;return ee(this,(function(o){return t=[],r=[],e.forEach((function(e){var o=n.getDsJsonsFromSingleLayerDefinition(null,e,r);r=r.concat(o),o.forEach((function(e){var r={id:e.id,dataSourceJson:e,parentDataSource:n,jimuChildId:n.getJimuChildIdFromChildDsId(e.id)};t.push(n.dataSourceManager.createDataSource(r))}))})),[2,Promise.allSettled(t).then((function(e){return e.filter((function(e){return"fulfilled"===e.status})).map((function(e){return e.value}))}))]}))}))}))),[2,this.childDataSourcesPromise]}))}))},t.prototype.getServiceDefinitionByLayer=function(){return this.getServiceDefinition()?this.getServiceDefinition():(this.serviceDefinition={name:this.layer.title},this.serviceDefinition)},t.prototype.fetchServiceDefnitionByItem=function(){return $(this,void 0,void 0,(function(){var e=this;return ee(this,(function(t){switch(t.label){case 0:return this.getServiceDefinition()?[4,Promise.resolve(this.getServiceDefinition())]:[3,2];case 1:return[2,t.sent()];case 2:return[4,o.requestUtils.requestWrapper(this.getDataSourceJson().portalUrl,(function(t){return $(e,void 0,void 0,(function(){var e=this;return ee(this,(function(r){switch(r.label){case 0:return[4,o.esri.restPortal.getItem(this.getDataSourceJson().itemId,{portal:o.portalUrlUtils.getPortalRestUrl(this.getDataSourceJson().portalUrl),authentication:t}).then((function(t){return e.serviceDefinition={name:t.title},e.serviceDefinition}))];case 1:return[2,r.sent()]}}))}))}))];case 3:return[2,t.sent()]}}))}))},t.prototype.fetchLayerDefinitionFromLayer=function(e){return $(this,void 0,void 0,(function(){var t,r,n;return ee(this,(function(i){switch(i.label){case 0:return t=o.dataSourceUtils.getUrlByLayer(e),r=o.dataSourceUtils.isSupportedService(t),n=o.dataSourceUtils.isJSAPILayerTypeSupported(e),r||n?[3,2]:[4,Promise.reject("Layer type is not supported. Layer is "+e+".")];case 1:return[2,i.sent()];case 2:return t?[4,o.ServiceManager.getInstance().fetchServiceInfo(t).then((function(r){return{layer:e,url:t,def:r.definition}}))]:[3,4];case 3:return[2,i.sent()];case 4:return[2,Promise.reject("Id of feature collection layer in group layer changes every time reload page")]}}))}))},t.prototype.getDsJsonsFromSingleLayer=function(e,t,r){var n=this;if(!t)return[];var a,u=[];return this.getJimuChildIdByJSAPILayerOrServiceDefinition(t,null,e,r).forEach((function(r){var s,c,l=n.getDataSourceJson().schema?null===(s=n.getDataSourceJson().schema.childSchemas)||void 0===s?void 0:s[r]:null,d=n.getChildDataSourceId(r),h=null===(c=n.getDataSourceJson().childDataSourceJsons)||void 0===c?void 0:c[r];t.type===i.g.GroupLayer?a=Object(o.Immutable)({id:d,type:i.c.GroupLayer}):t.type===i.g.FeatureLayer?a=Object(o.Immutable)({id:d,type:i.c.FeatureLayer,layerId:""+t.layerId}):t.type===i.g.SceneLayer?a=Object(o.Immutable)({id:d,type:i.c.SceneLayer,layerId:""+t.layerId}):t.type!==i.g.MapImageLayer&&t.type!==i.g.TileLayer||(a=Object(o.Immutable)({id:d,type:i.c.MapService})),a&&(n.getDataSourceJson().portalUrl&&(a=a.set("portalUrl",n.getDataSourceJson().portalUrl)),n.getDataSourceJson().itemId&&(a=a.set("itemId",n.getDataSourceJson().itemId)),l&&(a=a.set("schema",l)),e&&(a=a.set("url",e)),a=h?a.merge(h.asMutable({deep:!0})):a,u.push(a.set("jimuChildId",r)))})),u},t}(v),re=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),ne=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},oe=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},ie=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=i.c.MapService,t}return re(t,e),t.prototype.fetchServiceDefinition=function(){return ne(this,void 0,void 0,(function(){return oe(this,(function(e){switch(e.label){case 0:return[4,this.fetchServiceDefinitionByUrl()];case 1:return[2,e.sent()]}}))}))},t.prototype.createChildDataSources=function(){return ne(this,void 0,void 0,(function(){return oe(this,(function(e){switch(e.label){case 0:return this.layer?[4,this.createChildDataSourcesByLayer()]:[3,2];case 1:return[2,e.sent()];case 2:return[4,this.createChildDataSourcesByUrl()];case 3:return[2,e.sent()]}}))}))},t.prototype.createChildDataSourcesByLayer=function(){return ne(this,void 0,void 0,(function(){var e,t=this;return oe(this,(function(r){return this.childDataSourcesPromise||(e=this.layer.load().then((function(){return ne(t,void 0,void 0,(function(){var e,t,r=this;return oe(this,(function(n){switch(n.label){case 0:return e=(null===(t=this.layer.sublayers)||void 0===t?void 0:t.toArray())||[],[4,Promise.allSettled(e.map((function(e){return ne(r,void 0,void 0,(function(){return oe(this,(function(t){switch(t.label){case 0:return[4,this.fetchLayerDefinitionFromSubLayer(e)];case 1:return[2,t.sent()]}}))}))}))).then((function(e){var t=e.filter((function(e){return"fulfilled"===e.status})).map((function(e){return e.value})),r=[];return t.forEach((function(e){o.dataSourceUtils.isLayerDefinitionTypeSupported(e.def)&&(r=r.concat(e))})),r}))];case 1:return[2,n.sent()]}}))}))})),this.childDataSourcesPromise=e.then((function(e){return ne(t,void 0,void 0,(function(){var t,r,n=this;return oe(this,(function(i){return t=[],r=[],e.forEach((function(e){var i=n.getDsJsonsFromSingleLayerDefinition(o.dataSourceUtils.getDataSourceSourceUrl(e.url),e.def,r);r=r.concat(i),i.forEach((function(r){var o={id:r.id,dataSourceJson:r,parentDataSource:n,jimuChildId:n.getJimuChildIdFromChildDsId(r.id),layer:e.layer};t.push(n.dataSourceManager.createDataSource(o))}))})),[2,Promise.allSettled(t).then((function(e){return e.filter((function(e){return"fulfilled"===e.status})).map((function(e){return e.value}))}))]}))}))}))),[2,this.childDataSourcesPromise]}))}))},t.prototype.fetchLayerDefinitionFromSubLayer=function(e){return ne(this,void 0,void 0,(function(){var t;return oe(this,(function(r){switch(r.label){case 0:return(t=o.dataSourceUtils.getUrlByLayer(e))&&o.dataSourceUtils.isSupportedService(t)?[3,2]:[4,Promise.resolve(null)];case 1:return[2,r.sent()];case 2:return[4,o.ServiceManager.getInstance().fetchServiceInfo(t).then((function(r){return{layer:e,url:t,def:r.definition}}))];case 3:return[2,r.sent()]}}))}))},t}(v),ae=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),ue=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},se=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},ce=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=i.c.SimpleLocal,t}return ae(t,e),t.prototype.updateRecoreds=function(e){this.records=e,this.addVersion()},t.prototype.addRecord=function(e){return ue(this,void 0,void 0,(function(){return se(this,(function(t){switch(t.label){case 0:return e.getId()||e.setId(Object(o.uuidv1)()),this.records.push(e),this.addVersion(),[4,Promise.resolve(e)];case 1:return[2,t.sent()]}}))}))},t.prototype.updateRecord=function(e){return ue(this,void 0,void 0,(function(){var t;return se(this,(function(r){return t=this.records.findIndex((function(t){return t.getId()===e.getId()})),this.records.splice(t,1,e),this.addVersion(),[2,Promise.resolve(!0)]}))}))},t.prototype.deleteRecord=function(e){return ue(this,void 0,void 0,(function(){return se(this,(function(t){switch(t.label){case 0:return this.records.splice(e,1),this.addVersion(),[4,Promise.resolve(!0)];case 1:return[2,t.sent()]}}))}))},t}(s),le=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),de=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},he=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},fe=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=i.c.SceneService,t}return le(t,e),t.prototype.fetchServiceDefinition=function(){return de(this,void 0,void 0,(function(){return he(this,(function(e){switch(e.label){case 0:return[4,this.fetchServiceDefinitionByUrl()];case 1:return[2,e.sent()]}}))}))},t.prototype.createChildDataSources=function(){return de(this,void 0,void 0,(function(){return he(this,(function(e){switch(e.label){case 0:return[4,this.createChildDataSourcesByUrl()];case 1:return[2,e.sent()]}}))}))},t}(v),pe=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),ye=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))},ve=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},Se=function(e){function t(t){var r,n,a=e.call(this,t)||this;a.type=i.c.SceneLayer;var u=a.getDataSourceJson();if(a.portalUrl=u.portalUrl,a.itemId=u.itemId,a.layerId=u.layerId,t.layer&&(a.layer=t.layer),t.belongToDataSource&&t.belongToDataSource.layer&&(a.layer=t.belongToDataSource.layer),a.isLocal)(s=null===(r=t.belongToDataSource)||void 0===r?void 0:r.getAssociatedDataSource())&&o.DataSourceManager.getInstance().createLocalDataSource(s,a.localId);else if(a.isDataView){var s;(s=null===(n=t.belongToDataSource)||void 0===n?void 0:n.getAssociatedDataSource())&&o.DataSourceManager.getInstance().createDataView(s,a.dataViewId)}return a.getAssociatedDataSource()&&(Object(o.observeStore)(a.onInfoChange.bind(a),["dataSourcesInfo",a.getAssociatedDataSource().id]),a.getAssociatedDataSource().setAssociatedDataSource(a)),a}return pe(t,e),t.prototype.ready=function(){return ye(this,void 0,void 0,(function(){var t=this;return ve(this,(function(r){switch(r.label){case 0:return[4,Promise.all([this.fetchLayerDefinition(),this.createAssociatedDataSource()]).then((function(){return ye(t,void 0,void 0,(function(){return ve(this,(function(t){switch(t.label){case 0:return[4,e.prototype.ready.call(this)];case 1:return[2,t.sent()]}}))}))})).then((function(){t.getAssociatedDataSource()&&Object(o.observeStore)(t.onInfoChange.bind(t),["dataSourcesInfo",t.getAssociatedDataSource().id])}))];case 1:return[2,r.sent()]}}))}))},t.prototype.onInfoChange=function(){this.getAssociatedDataSource()&&!o.utils.isDeepEqual(this.getInfo().without("instanceStatus"),this.getAssociatedDataSource().getInfo().without("instanceStatus"))&&Object(o.getAppStore)().dispatch(o.appActions.updateDataSourceInfo(this.id,this.getAssociatedDataSource().getInfo().without("instanceStatus").set("instanceStatus",this.getInfo().instanceStatus)))},t.prototype.createAssociatedDataSource=function(){return ye(this,void 0,void 0,(function(){var e=this;return ve(this,(function(t){switch(t.label){case 0:return this.associatedDataSource?[4,Promise.resolve(this.associatedDataSource)]:[3,2];case 1:return[2,t.sent()];case 2:return this.layer?[4,this._createAssociatedDataSourceWithLayer().then((function(t){return t||e._createAssociatedDataSourceWithUrl()}))]:[3,4];case 3:return[2,t.sent()];case 4:return[2,this._createAssociatedDataSourceWithUrl()]}}))}))},t.prototype._createAssociatedDataSourceWithLayer=function(){return ye(this,void 0,void 0,(function(){var e,t=this;return ve(this,(function(r){switch(r.label){case 0:return e=this._getNewAssociatedDataSourceId(),[4,this.layer.load().then((function(){return ye(t,void 0,void 0,(function(){var t,r,n;return ve(this,(function(a){switch(a.label){case 0:return this.layer.associatedLayer?(t=Object(o.Immutable)({id:e,type:i.c.FeatureLayer,url:o.dataSourceUtils.getUrlByLayer(this.layer.associatedLayer)}),(r=this.getDataSourceJson().schema)&&(t=t.set("schema",r)),n={id:e,dataSourceJson:t,layer:this.layer.associatedLayer,associatedDataSource:this},[4,this.dataSourceManager.createDataSource(n)]):[2,null];case 1:return[2,a.sent()]}}))}))})).then((function(e){return t.associatedDataSource=e,t.associatedDataSource}))];case 1:return[2,r.sent()]}}))}))},t.prototype._createAssociatedDataSourceWithUrl=function(){return ye(this,void 0,void 0,(function(){var e,t=this;return ve(this,(function(r){switch(r.label){case 0:return e=this._getNewAssociatedDataSourceId(),[4,o.dataSourceUtils.fetchAssociatedFeatureLayerDefinition(this.url,this.layerId,this.itemId,this.portalUrl).then((function(r){if(!r)return Promise.reject("Can not find associated feature layer");var n=o.dataSourceUtils.getSingleDsJsonFromLayerDefinition(e,r.url,r.def);return n=t._mergeAssociatedDataSourceJson(n)})).then((function(e){return ye(t,void 0,void 0,(function(){var t;return ve(this,(function(r){switch(r.label){case 0:return t={id:e.id,dataSourceJson:e,associatedDataSource:this},[4,this.dataSourceManager.createDataSource(t)];case 1:return[2,r.sent()]}}))}))})).then((function(e){return t.associatedDataSource=e,t.associatedDataSource}))];case 1:return[2,r.sent()]}}))}))},t.prototype._getNewAssociatedDataSourceId=function(){return this.getDataSourceJson().id+"-associated_data_source"},t.prototype.fetchLayerDefinition=function(){return ye(this,void 0,void 0,(function(){var e,t=this;return ve(this,(function(r){switch(r.label){case 0:return(e=this.url)?[3,2]:[4,Promise.resolve(null)];case 1:return[2,r.sent()];case 2:return this.getLayerDefinition()?[4,Promise.resolve(this.getLayerDefinition())]:[3,4];case 3:return[2,r.sent()];case 4:return[4,o.ServiceManager.getInstance().fetchServiceInfo(e).then((function(e){return e.definition})).then((function(e){return e?(t.layerDefinition=e,e):null}))];case 5:return[2,r.sent()]}}))}))},t.prototype.getLayerDefinition=function(){return o.dataSourceUtils.getLayerDefinition(this)},t.prototype.fetchSchema=function(){return ye(this,void 0,void 0,(function(){var e,t,r;return ve(this,(function(n){switch(n.label){case 0:return[4,o.dataSourceUtils.getOriginDataLabel(this.getLayerDefinition(),this.layer,this.getDataSourceJson())];case 1:return e=n.sent(),t=Object(o.Immutable)({label:e}),[4,this.getAssociatedDataSource()?this.getAssociatedDataSource().fetchSchema():Promise.reject({})];case 2:return[2,(r=n.sent())?r.merge(t):t]}}))}))},t.prototype.getSchema=function(){var t,r=null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getSchema(),n=e.prototype.getSchema.call(this);return r?r.merge(n):n},t.prototype.setSchema=function(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setSchema(e)},t.prototype.setDataSourceJson=function(t){e.prototype.setDataSourceJson.call(this,t);var r=this.getAssociatedDataSource();if(r){var n=this._mergeAssociatedDataSourceJson(r.getDataSourceJson());r.setDataSourceJson(n)}},t.prototype.getFetchedSchema=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getFetchedSchema()},t.prototype.setFetchedSchema=function(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setFetchedSchema(e)},t.prototype.getReversedConfigSchema=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getReversedConfigSchema()},t.prototype.getSelectedFields=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSelectedFields()},t.prototype.setSelectedFields=function(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setSelectedFields(e)},t.prototype.getIdField=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getIdField()},t.prototype.setJsonData=function(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setJsonData(e)},t.prototype.queryById=function(e){var t,r;return ye(this,void 0,void 0,(function(){return ve(this,(function(n){switch(n.label){case 0:return[4,null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.queryById(e)];case 1:return[2,null!==(r=n.sent())&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))]}}))}))},t.prototype.addRecord=function(e){var t;return ye(this,void 0,void 0,(function(){return ve(this,(function(r){switch(r.label){case 0:return[4,null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.addRecord(e)];case 1:return[2,r.sent()]}}))}))},t.prototype.updateRecord=function(e){var t;return ye(this,void 0,void 0,(function(){return ve(this,(function(r){switch(r.label){case 0:return[4,null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.updateRecord(e)];case 1:return[2,r.sent()]}}))}))},t.prototype.updateRecords=function(e){var t;return ye(this,void 0,void 0,(function(){return ve(this,(function(r){switch(r.label){case 0:return[4,null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.updateRecords(e)];case 1:return[2,r.sent()]}}))}))},t.prototype.deleteRecord=function(e){var t;return ye(this,void 0,void 0,(function(){return ve(this,(function(r){switch(r.label){case 0:return[4,null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.deleteRecord(e)];case 1:return[2,r.sent()]}}))}))},t.prototype.deleteRecordById=function(e){var t;return ye(this,void 0,void 0,(function(){return ve(this,(function(r){switch(r.label){case 0:return[4,null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.deleteRecordById(e)];case 1:return[2,r.sent()]}}))}))},t.prototype.doQuery=function(e,t){var r,n;return ye(this,void 0,void 0,(function(){return ve(this,(function(o){switch(o.label){case 0:return[4,null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.doQuery(e,t)];case 1:return[2,null!==(n=o.sent())&&void 0!==n?n:Promise.reject(Error("No Associated DataSource."))]}}))}))},t.prototype.doQueryById=function(e){var t,r;return ye(this,void 0,void 0,(function(){return ve(this,(function(n){switch(n.label){case 0:return[4,null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.doQueryById(e)];case 1:return[2,null!==(r=n.sent())&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))]}}))}))},t.prototype.doQueryCount=function(e){var t,r;return ye(this,void 0,void 0,(function(){return ve(this,(function(n){switch(n.label){case 0:return[4,null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.doQueryCount(e)];case 1:return[2,null!==(r=n.sent())&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))]}}))}))},t.prototype.getConfigQueryParams=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getConfigQueryParams()},t.prototype.getRemoteQueryParams=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getRemoteQueryParams()},t.prototype.getCurrentQueryParams=function(e){var t;return e&&this.fixExcludeQuery(e),null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getCurrentQueryParams(e)},t.prototype.getRuntimeQueryParamsgetRuntimeQueryParams=function(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRuntimeQueryParams(e)},t.prototype.getCurrentQueryId=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getCurrentQueryId()},t.prototype.mergeQueryParams=function(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.mergeQueryParams(e,t)},t.prototype.getFieldCodedValueList=function(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.getFieldCodedValueList(e,t)},t.prototype.getRealQueryParams=function(e,t,r){var n;return r&&this.fixQueryOptions(r),null===(n=this.getAssociatedDataSource())||void 0===n?void 0:n.getRealQueryParams(e,t,r)},t.prototype.updateQueryParams=function(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.updateQueryParams(e,t)},t.prototype.getGDBVersion=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getGDBVersion()},t.prototype.getQueryPageSize=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getQueryPageSize()},t.prototype.getMaxRecordCount=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getMaxRecordCount()},t.prototype.getRecordsByPage=function(e,t,r){var n;return void 0===r&&(r=!0),null===(n=this.getAssociatedDataSource())||void 0===n?void 0:n.getRecordsByPage(e,t,r)},t.prototype.getPagesData=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getPagesData()},t.prototype.setPagesData=function(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setPagesData(e)},t.prototype.getRealQueryPages=function(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.getRealQueryPages(e,t)},t.prototype.load=function(e,t){var r,n;return void 0===t&&(t={}),ye(this,void 0,void 0,(function(){return ve(this,(function(o){switch(o.label){case 0:return t&&this.fixQueryOptions(t),[4,null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.load(e,t)];case 1:return[2,null!==(n=o.sent())&&void 0!==n?n:Promise.reject(Error("No Associated DataSource."))]}}))}))},t.prototype.loadCount=function(e,t){var r,n;return void 0===t&&(t={}),ye(this,void 0,void 0,(function(){return ve(this,(function(o){switch(o.label){case 0:return t&&this.fixQueryOptions(t),[4,null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.loadCount(e,t)];case 1:return[2,null!==(n=o.sent())&&void 0!==n?n:Promise.reject(Error("No Associated DataSource."))]}}))}))},t.prototype.query=function(e,t){var r,n;return ye(this,void 0,void 0,(function(){return ve(this,(function(o){switch(o.label){case 0:return t&&this.fixQueryOptions(t),[4,null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.query(e,t)];case 1:return[2,null!==(n=o.sent())&&void 0!==n?n:Promise.reject(Error("No Associated DataSource."))]}}))}))},t.prototype.queryCount=function(e,t){var r,n;return ye(this,void 0,void 0,(function(){return ve(this,(function(o){switch(o.label){case 0:return t&&this.fixQueryOptions(t),[4,null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.queryCount(e,t)];case 1:return[2,null!==(n=o.sent())&&void 0!==n?n:Promise.reject(Error("No Associated DataSource."))]}}))}))},t.prototype.loadById=function(e,t){var r,n;return ye(this,void 0,void 0,(function(){return ve(this,(function(o){switch(o.label){case 0:return[4,null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.loadById(e,t)];case 1:return[2,null!==(n=o.sent())&&void 0!==n?n:Promise.reject(Error("No Associated DataSource."))]}}))}))},t.prototype.changeGDBVersion=function(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.changeGDBVersion(e)},t.prototype.getAssociatedDataSource=function(){if(!this.isDataView&&!this.isLocal)return this.associatedDataSource;var e=this._getRealAssociatedDataSourceId();return o.DataSourceManager.getInstance().getDataSource(e)},t.prototype.getAssociatedDataSourceById=function(e){return this.dataSourceManager.getDataSource(e).getAssociatedDataSource()},t.prototype.fixQueryOptions=function(e){e&&e.excludeQuery&&this.fixExcludeQuery(e.excludeQuery)},t.prototype.fixExcludeQuery=function(e){(null==e?void 0:e.dataSourceId)&&this.getAssociatedDataSourceById(e.dataSourceId)&&(e.dataSourceId=this.getAssociatedDataSourceById(e.dataSourceId).id)},t.prototype._getRealAssociatedDataSourceId=function(){var e,t=null===(e=this.belongToDataSource)||void 0===e?void 0:e.associatedDataSource;return this.isLocal?o.DataSourceManager.getInstance().getLocalDataSourceId(null==t?void 0:t.id,this.localId):this.isDataView?o.DataSourceManager.getInstance().getDataViewDataSourceId(null==t?void 0:t.id,this.dataViewId):this.associatedDataSource.id},t.prototype.clearRecords=function(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.clearRecords()},t.prototype.setRecords=function(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setRecords(e)},t.prototype.getRecords=function(e){var t;return void 0===e&&(e=!0),null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRecords(e)},t.prototype.getSelectedRecords=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSelectedRecords()},t.prototype.getSelectedRecordIndexes=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSelectedRecordIndexes()},t.prototype.getSelectedRecordIds=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSelectedRecordIds()},t.prototype.nextRecord=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.nextRecord()},t.prototype.prevRecord=function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.prevRecord()},t.prototype.getRecord=function(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRecord(e)},t.prototype.getRecordById=function(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRecordById(e)},t.prototype.clearSelection=function(){var t;e.prototype.clearSelection.call(this),null===(t=this.getAssociatedDataSource())||void 0===t||t.clearSelection()},t.prototype.addVersion=function(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.addVersion()},t.prototype.selectRecord=function(t){var r;e.prototype.selectRecord.call(this,t),null===(r=this.getAssociatedDataSource())||void 0===r||r.selectRecord(t)},t.prototype.selectRecords=function(t){var r;e.prototype.selectRecords.call(this,t),null===(r=this.getAssociatedDataSource())||void 0===r||r.selectRecords(t)},t.prototype.selectRecordById=function(t,r){var n;e.prototype.selectRecordById.call(this,t,r),null===(n=this.getAssociatedDataSource())||void 0===n||n.selectRecordById(t,r)},t.prototype.selectRecordsByIds=function(t,r){var n;e.prototype.selectRecordsByIds.call(this,t,r),null===(n=this.getAssociatedDataSource())||void 0===n||n.selectRecordsByIds(t,r)},t.prototype.destroy=function(){var e=this.getAssociatedDataSource();e&&this.dataSourceManager.destroyDataSource(e.id)},t.prototype.supportSymbol=function(){return o.dataSourceUtils.supportSymbol(this)},t.prototype.supportAttachment=function(){return o.dataSourceUtils.supportAttachment(this)},t.prototype._mergeAssociatedDataSourceJson=function(e){return null==e?void 0:e.set("query",this.getDataSourceJson().query).set("dataViews",this.getDataSourceJson().dataViews)},Object.defineProperty(t.prototype,"count",{get:function(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.count},set:function(e){this.getAssociatedDataSource()&&(this.getAssociatedDataSource().count=e)},enumerable:!1,configurable:!0}),t.prototype.getPopupInfo=function(){return ye(this,void 0,void 0,(function(){return ve(this,(function(e){switch(e.label){case 0:return[4,o.dataSourceUtils.getPopupInfo(this)];case 1:return[2,e.sent()]}}))}))},t.prototype.allowToExportData=function(){var e=!this.getDataSourceJson().disableExport;return Promise.resolve(e)},t}(V),ge=function(){function e(){}return e.prototype.createDataSource=function(e){var t,r,n=null!==(t=e.dataSourceJson)&&void 0!==t?t:e.belongToDataSource.getMainDataSource().getDataSourceJson();return(r=e.dataViewId&&e.dataViewId===o.CONSTANTS.SELECTION_DATA_VIEW_ID?i.c.FeatureLayer:e.dataViewId&&n.dataViews&&n.dataViews[e.dataViewId]&&n.dataViews[e.dataViewId].type||n.type)===i.c.CSV?new N(e):r===i.c.FeatureLayer?new z(e):r===i.c.FeatureService?new K(e):r===i.c.GroupLayer?new te(e):r===i.c.MapService?new ie(e):r===i.c.SceneService?new fe(e):r===i.c.SceneLayer?new Se(e):r===i.c.SimpleLocal?new ce(e):void console.error("Unimplemented data source type.",n.type)},e}();t.default=ge},2:function(e,t,r){"use strict";r.d(t,"b",(function(){return o})),r.d(t,"c",(function(){return i})),r.d(t,"f",(function(){return a})),r.d(t,"h",(function(){return u})),r.d(t,"e",(function(){return s})),r.d(t,"g",(function(){return c})),r.d(t,"d",(function(){return l})),r.d(t,"a",(function(){return h}));var n,o,i,a,u,s,c,l,d=(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});!function(e){e.NotCreated="NOT_CREATED",e.Created="CREATED",e.CreateError="CREATE_ERROR",e.NotReady="NOT_READY",e.Unloaded="UNLOADED",e.Loading="LOADING",e.Loaded="LOADED",e.LoadError="LOAD_ERROR",e.Saving="SAVING",e.Saved="SAVED",e.SaveError="SAVE_ERROR",e.Closed="CLOSED",e.Connecting="CONNECTING",e.Connected="CONNECTED",e.Closing="CLOSING"}(o||(o={})),function(e){e.SimpleLocal="SIMPLE_LOCAL",e.CSV="CSV",e.FeatureLayer="FEATURE_LAYER",e.SceneLayer="SCENE_LAYER",e.GroupLayer="GROUP_LAYER",e.FeatureService="FEATURE_SERVICE",e.MapService="MAP_SERVICE",e.SceneService="SCENE_SERVICE"}(i||(i={})),function(e){e.FeatureLayer="Feature Layer",e.Table="Table",e.GroupLayer="Group Layer",e.SceneLayerPoint="Point",e.SceneLayer3DObject="3DObject"}(a||(a={})),function(e){e.FeatureService="FeatureServer",e.MapService="MapServer",e.SceneService="SceneServer"}(u||(u={})),function(e){e.WebMap="Web Map",e.WebScene="Web Scene",e.FeatureService="Feature Service",e.MapService="Map Service",e.SceneService="Scene Service",e.FeatureCollection="Feature Collection"}(s||(s={})),function(e){e.FeatureLayer="feature",e.MapImageLayer="map-image",e.TileLayer="tile",e.GroupLayer="group",e.SceneLayer="scene"}(c||(c={})),function(e){e.InAllData="IN_ALL_DATA",e.InRemoteConfigView="IN_REMOTE_CONFIG_VIEW",e.InConfigView="IN_CONFIG_VIEW",e.InRuntimeView="IN_RUNTIME_VIEW"}(l||(l={}));var h=function(e){function t(t,r){var n=e.call(this,r)||this;return n.dataSourceId=t,n}return d(t,e),t}(Error)}}))}}}));