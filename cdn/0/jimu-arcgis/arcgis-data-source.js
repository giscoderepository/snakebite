System.register(["jimu-core","jimu-core/data-source"],(function(e){var t,r;return{setters:[function(e){t=e},function(e){r=e}],execute:function(){e(function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=4)}([function(e,r){e.exports=t},function(e,t,r){"use strict";var n,a;r.d(t,"b",(function(){return n})),r.d(t,"c",(function(){return a})),r.d(t,"a",(function(){return n})),function(e){e.Map="MAP",e.WebMap="WEB_MAP",e.WebScene="WEB_SCENE"}(n||(n={})),function(e){e.BaseDynamicLayer="base-dynamic",e.BaseElevationLayer="base-elevation",e.BaseTileLayer="base-tile",e.BuildingSceneLayer="building-scene",e.CSVLayer="csv",e.ElevationLayer="elevation",e.FeatureLayer="feature",e.GeoJSONLayer="geojson",e.GeoRSSLayer="geo-rss",e.GraphicsLayer="graphics",e.GroupLayer="group",e.ImageryLayer="imagery",e.IntegratedMeshLayer="integrated-mesh",e.KMLLayer="kml",e.MapImageLayer="map-image",e.MapNotesLayer="map-notes",e.PointCloudLayer="point-cloud",e.SceneLayer="scene",e.TileLayer="tile",e.UnknownLayer="unknown",e.UnsupportedLayer="unsupported",e.VectorTileLayer="vector-tile",e.WMSLayer="wms",e.WMTSLayer="wmts",e.WebTileLayer="web-tile"}(a||(a={}))},function(e,t){e.exports=r},,function(e,t,r){"use strict";r.r(t),r.d(t,"ArcGISDataSourceFactory",(function(){return b})),r.d(t,"MapDataSourceImpl",(function(){return l})),r.d(t,"WebMapDataSourceImpl",(function(){return y})),r.d(t,"WebSceneDataSourceImpl",(function(){return m})),r.d(t,"DataSourceTypes",(function(){return a.b})),r.d(t,"LayerTypes",(function(){return a.c})),r.d(t,"ArcGISDataSourceTypes",(function(){return a.a}));var n,a=r(1),o=r(2),i=r(0),u=(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),c=function(e,t,r,n){return new(r||(r=Promise))((function(a,o){function i(e){try{c(n.next(e))}catch(e){o(e)}}function u(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,u)}c((n=n.apply(e,t||[])).next())}))},s=function(e,t){var r,n,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(a=2&o[0]?n.return:o[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,o[1])).done)return a;switch(n=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,n=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],n=0}finally{r=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}},l=function(e){function t(t){var r=e.call(this,t)||this;return r.type=a.b.Map,r.map=t.map,r}return u(t,e),t.prototype.ready=function(){return c(this,void 0,void 0,(function(){var e=this;return s(this,(function(t){switch(t.label){case 0:return[4,Object(i.loadArcGISJSAPIModules)(["esri/Map","esri/layers/FeatureLayer"]).then((function(t){return c(e,void 0,void 0,(function(){return s(this,(function(e){switch(e.label){case 0:return this.Map=t[0],this.FeatureLayer=t[1],this.map||this.createMap(),[4,this.createChildDataSources()];case 1:return[2,e.sent()]}}))}))}))];case 1:return[2,t.sent()]}}))}))},t.prototype.fetchSchema=function(){var e,t;return c(this,void 0,void 0,(function(){var r,n;return s(this,(function(a){return r=this.getChildDataSources(),n=Object(i.Immutable)({childSchemas:{},label:null===(t=null===(e=this.map)||void 0===e?void 0:e.portalItem)||void 0===t?void 0:t.title}),r.forEach((function(e,t){var r=e.getFetchedSchema();n=n.setIn(["childSchemas",e.jimuChildId],r)})),[2,Promise.resolve(n)]}))}))},t.prototype.getDataSourceByLayer=function(e,t){return"number"==typeof e&&(e=""+e),e?this.deepSearchDataSourceByLayer(this,e,t):null},t.prototype.getDataSourcesByType=function(e){if(!e)return[];var t=[];return this.traverseToGetDataSourcesByType(e,this,t),t},t.prototype.createChildDataSources=function(){return c(this,void 0,void 0,(function(){var e,t,r=this;return s(this,(function(n){return e=[],t=[],i.dataSourceUtils.getWhetherUseProxy()&&this.map.allLayers.toArray().forEach((function(e){var t=i.dataSourceUtils.getUrlByLayer(e);if(t){var r=i.dataSourceUtils.getDataSourceProxyUrl(t);r&&(e.url=r)}})),this.map.layers.toArray().forEach((function(n){var a=i.dataSourceUtils.getUrlByLayer(n),o=i.dataSourceUtils.getDataSourceSourceUrl(a),u=i.dataSourceUtils.getFixedLayerIdByLayer(n);t.push(r.getDataSourceConstructorOptions(u,o,r.getDataSourceJson(),n).then((function(t){t.forEach((function(t){e.push(r.dataSourceManager.createDataSource(t))}))})))})),this.childDataSourcesPromise=Promise.allSettled(t).then((function(){return c(r,void 0,void 0,(function(){var t=this;return s(this,(function(r){switch(r.label){case 0:return[4,Promise.allSettled(e).then((function(e){return c(t,void 0,void 0,(function(){var t,r,n=this;return s(this,(function(a){return t=[],(r=e.filter((function(e){return"fulfilled"===e.status})).map((function(e){return e.value})))&&r.length>0&&r.forEach((function(e){return n.traverseToCreateLayerForDataSource(e,t)})),[2,Promise.allSettled(t.map((function(e){return c(n,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return[4,e.load()];case 1:return[2,t.sent()]}}))}))}))).then((function(e){return r}))]}))}))}))];case 1:return[2,r.sent()]}}))}))})),[2,this.childDataSourcesPromise]}))}))},t.prototype.deepSearchDataSourceByLayer=function(e,t,r){if(!e||!t)return null;if(this.isDataSourceWithLayer(e,t,r))return e;var n=null,a=e.isDataSourceSet&&e.getChildDataSources();if(a)for(var o=0;o<a.length&&!(n=this.deepSearchDataSourceByLayer(a[o],t,r));o++);return n},t.prototype.traverseToGetDataSourcesByType=function(e,t,r){var n=this;if(e&&t&&r){t.type===e&&r.push(t);var a=t.isDataSourceSet&&t.getChildDataSources();a&&a.forEach((function(t){n.traverseToGetDataSourcesByType(e,t,r)}))}},t.prototype.traverseToCreateLayerForDataSource=function(e,t){var r=this;if(e){this.getWhetherNeedToCreateLayer(e)&&e.type===o.DataSourceTypes.FeatureLayer&&e.layer.url&&(e.layer=new this.FeatureLayer({id:e.layer.id,url:i.dataSourceUtils.getUrlByLayer(e.layer),renderer:e.layer.renderer,popupTemplate:e.layer.popupTemplate}),t.push(e.layer));var n=e.isDataSourceSet&&e.getChildDataSources();n&&n.forEach((function(e){r.traverseToCreateLayerForDataSource(e,t)}))}},t.prototype.getWhetherNeedToCreateLayer=function(e){return!!e&&(!e.layer||"esri.layers.support.Sublayer"===e.layer.declaredClass)},t.prototype.isDataSourceWithLayer=function(e,t,r){var n,a,i;if(""+(null===(a=null===(n=e)||void 0===n?void 0:n.layer)||void 0===a?void 0:a.id)==""+t){if(r){for(var u=null,c=null==e?void 0:e.parentDataSource;c;){if(c.type===o.DataSourceTypes.MapService){u=c;break}c=c.parentDataSource}return r===(null===(i=null==u?void 0:u.layer)||void 0===i?void 0:i.id)}return!0}return!1},t.prototype.createMap=function(){var e=this;this.map=new this.Map,this.getDataSourceJson().layers.forEach((function(t){e.map.layers.add(new e.FeatureLayer(t))}))},t.prototype.getDataSourceConstructorOptions=function(e,t,r,n){return c(this,void 0,void 0,(function(){var a,u,l,p=this;return s(this,(function(f){switch(f.label){case 0:return e?[3,2]:[4,Promise.resolve([])];case 1:return[2,f.sent()];case 2:return a=[],u=[],l=[],this.getJimuChildId(e).forEach((function(e){var f,h,y=p.getDataSourceJson().schema?p.getDataSourceJson().schema.childSchemas[e]:null,d=p.getChildDataSourceId(e),S=(null==r?void 0:r.childDataSourceJsons)&&r.childDataSourceJsons[e]?r.childDataSourceJsons[e]:null,v=Object(i.Immutable)({id:d,type:o.DataSourceTypes.FeatureLayer});if(S&&(v=v.merge(S.asMutable({deep:!0}))),t&&(v=v.set("url",t.replace(/^http:/,"https:"))),y&&(v=v.set("schema",y)),n){if((null===(f=n.portalItem)||void 0===f?void 0:f.id)&&(v=v.set("portalUrl",n.portalItem.portal.url).set("itemId",n.portalItem.id)),n.type===i.SupportedLayerTypes.SceneLayer)u.push(n.load().then((function(){return c(p,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return n.associatedLayer?[3,2]:[4,Promise.reject(null)];case 1:return[2,t.sent()];case 2:return[4,Promise.resolve({id:v.id,dataSourceJson:v.set("type",o.DataSourceTypes.SceneLayer),layer:n,parentDataSource:this,jimuChildId:e})];case 3:return[2,t.sent()]}}))}))})));else switch(n.type){case i.SupportedLayerTypes.FeatureLayer:l.push(n.load().then((function(){return c(p,void 0,void 0,(function(){var t,r,a,o;return s(this,(function(i){switch(i.label){case 0:return"multipatch"!==n.geometryType&&"mesh"!==n.geometryType?[3,2]:(t="Do not support feature layer which geometry type is multipatch or mesh.",console.error(t,n),[4,Promise.reject(t)]);case 1:return[2,i.sent()];case 2:return r="esriGeometry"+(null===(a=n.geometryType)||void 0===a?void 0:a.charAt(0).toUpperCase())+(null===(o=n.geometryType)||void 0===o?void 0:o.slice(1)),[4,Promise.resolve({id:v.id,dataSourceJson:v.set("geometryType",r),layer:n,parentDataSource:this,jimuChildId:e})];case 3:return[2,i.sent()]}}))}))})));break;case i.SupportedLayerTypes.MapImageLayer:case i.SupportedLayerTypes.TileLayer:h={id:v.id,dataSourceJson:v.set("type",o.DataSourceTypes.MapService),layer:n,parentDataSource:p,jimuChildId:e};break;case i.SupportedLayerTypes.GroupLayer:h={id:v.id,dataSourceJson:v.set("type",o.DataSourceTypes.GroupLayer),layer:n,parentDataSource:p,jimuChildId:e}}h&&a.push(Promise.resolve(h))}else h={id:v.id,dataSourceJson:v,parentDataSource:p,jimuChildId:e},a.push(Promise.resolve(h))})),[4,Promise.allSettled(a.concat(u).concat(l)).then((function(e){return e.filter((function(e){return"fulfilled"===e.status})).map((function(e){return e.value}))}))];case 3:return[2,f.sent()]}}))}))},t}(o.AbstractSetDataSource),p=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),f=function(e,t,r,n){return new(r||(r=Promise))((function(a,o){function i(e){try{c(n.next(e))}catch(e){o(e)}}function u(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,u)}c((n=n.apply(e,t||[])).next())}))},h=function(e,t){var r,n,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(a=2&o[0]?n.return:o[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,o[1])).done)return a;switch(n=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,n=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],n=0}finally{r=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}},y=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=a.b.WebMap,t}return p(t,e),t.prototype.ready=function(){return f(this,void 0,void 0,(function(){var e=this;return h(this,(function(t){switch(t.label){case 0:return[4,Object(i.loadArcGISJSAPIModules)(["esri/WebMap","esri/portal/Portal","esri/portal/PortalItem","esri/layers/FeatureLayer"]).then((function(t){return f(e,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return this.WebMap=t[0],this.Portal=t[1],this.PortalItem=t[2],this.FeatureLayer=t[3],this.map||this.createMap(),[4,this.createChildDataSources()];case 1:return[2,e.sent()]}}))}))}))];case 1:return[2,t.sent()]}}))}))},t.prototype.createMap=function(){if(this.getDataSourceJson().portalUrl){var e=new this.Portal({url:i.portalUrlUtils.getHostUrlByOrgUrl(this.getDataSourceJson().portalUrl)});this.map=new this.WebMap({portalItem:new this.PortalItem({id:this.getDataSourceJson().itemId,portal:e})})}else this.map=new this.WebMap({portalItem:new this.PortalItem({id:this.getDataSourceJson().itemId})});this.map.isFulfilled()||this.map.load()},t.prototype.createChildDataSources=function(){return f(this,void 0,void 0,(function(){var t=this;return h(this,(function(r){return this.childDataSourcesPromise=this.map.when((function(){return f(t,void 0,void 0,(function(){var t,r,n,a,o,u=this;return h(this,(function(c){return t=this.map.tables?this.map.tables.toArray():[],i.dataSourceUtils.getWhetherUseProxy()&&t.forEach((function(e){var t=i.dataSourceUtils.getUrlByLayer(e);if(t){var r=i.dataSourceUtils.getDataSourceProxyUrl(t);r&&(e.url=r)}})),r=[],n=[],t.forEach((function(e){n.push(u.getDataSourceConstructorOptions(i.dataSourceUtils.getFixedLayerIdByLayer(e),i.dataSourceUtils.getDataSourceSourceUrl(i.dataSourceUtils.getUrlByLayer(e)),u.getDataSourceJson()).then((function(e){e.forEach((function(e){r.push(u.dataSourceManager.createDataSource(e))}))})))})),a=e.prototype.createChildDataSources.call(this),o=Promise.allSettled(n).then((function(){return f(u,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return[4,Promise.allSettled(r).then((function(e){return e.filter((function(e){return"fulfilled"===e.status})).map((function(e){return e.value}))}))];case 1:return[2,e.sent()]}}))}))})),[2,Promise.all([a,o]).then((function(e){return e[0].concat(e[1])}))]}))}))})),[2,this.childDataSourcesPromise]}))}))},t}(l),d=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),S=function(e,t,r,n){return new(r||(r=Promise))((function(a,o){function i(e){try{c(n.next(e))}catch(e){o(e)}}function u(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,u)}c((n=n.apply(e,t||[])).next())}))},v=function(e,t){var r,n,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(a=2&o[0]?n.return:o[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,o[1])).done)return a;switch(n=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,n=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],n=0}finally{r=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}},m=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=a.b.WebScene,t}return d(t,e),t.prototype.ready=function(){return S(this,void 0,void 0,(function(){var e=this;return v(this,(function(t){switch(t.label){case 0:return[4,Object(i.loadArcGISJSAPIModules)(["esri/WebScene","esri/portal/Portal","esri/portal/PortalItem","esri/layers/FeatureLayer"]).then((function(t){return S(e,void 0,void 0,(function(){return v(this,(function(e){switch(e.label){case 0:return this.WebScene=t[0],this.Portal=t[1],this.PortalItem=t[2],this.FeatureLayer=t[3],this.map||this.createMap(),[4,this.createChildDataSources()];case 1:return[2,e.sent()]}}))}))}))];case 1:return[2,t.sent()]}}))}))},t.prototype.createMap=function(){if(this.getDataSourceJson().portalUrl){var e=new this.Portal({url:i.portalUrlUtils.getHostUrlByOrgUrl(this.getDataSourceJson().portalUrl)});this.map=new this.WebScene({portalItem:new this.PortalItem({id:this.getDataSourceJson().itemId,portal:e})})}else this.map=new this.WebScene({portalItem:new this.PortalItem({id:this.getDataSourceJson().itemId})});this.map.isFulfilled()||this.map.load()},t.prototype.createChildDataSources=function(){return S(this,void 0,void 0,(function(){var t=this;return v(this,(function(r){return[2,this.childDataSourcesPromise=this.map.when((function(){return S(t,void 0,void 0,(function(){return v(this,(function(t){switch(t.label){case 0:return[4,e.prototype.createChildDataSources.call(this)];case 1:return[2,t.sent()]}}))}))}))]}))}))},t}(l),b=function(){function e(){}return e.prototype.createDataSource=function(e){var t,r=null!==(t=e.dataSourceJson)&&void 0!==t?t:e.belongToDataSource.getMainDataSource().getDataSourceJson(),n=e.dataViewId&&r.dataViews&&r.dataViews[e.dataViewId]&&r.dataViews[e.dataViewId].type||r.type;return n===a.b.Map?new l(e):n===a.b.WebMap?new y(e):n===a.b.WebScene?new m(e):void console.error("Unimplemented data source type.",n)},e}();t.default=b}]))}}}));